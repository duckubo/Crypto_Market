/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,l){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,l){e.__proto__=l}||function(e,l){for(var t in l)l.hasOwnProperty(t)&&(e[t]=l[t])})(e,l)};return function(e,l){extendStatics(e,l);function __(){this.constructor=e}e.prototype=null===l?Object.create(l):(__.prototype=l.prototype,new __)}}();import{_getModule,Control,Globalize,DataType,asBoolean,isString,isNumber,isInt,isDate,isFunction,isNullOrWhiteSpace,isObject,asEnum,getType,copy,_deprecated,cellCoordinateParserRegex,_registerModule}from"@mescius/wijmo";import{FlexGrid,Row,GroupRow,Column,CellRange,CellRangeEventArgs,RowColFlags,CellType,_NewRowTemplate,GroupSummaryPosition}from"@mescius/wijmo.grid";import*as mXlsx from"@mescius/wijmo.xlsx";import*as selfModule from"@mescius/wijmo.grid.xlsx";export function softDetail(){return _getModule("wijmo.grid.detail")}export function softMultiRow(){return _getModule("wijmo.grid.multirow")}export function softTransposed(){return _getModule("wijmo.grid.transposed")}export function softTransposedMultiRow(){return _getModule("wijmo.grid.transposedmultirow")}var FlexGridXlsxConverter=function(){function FlexGridXlsxConverter(){}FlexGridXlsxConverter.save=function(e,l,t,o){var r=new mXlsx.Workbook;this._saveFlexGridToWorkbook(r,e,l,!1,null,void 0,o);t&&r.save(t);return r};FlexGridXlsxConverter.saveAsync=function(e,l,t,o,r,n,s,i){var a=this,u=new mXlsx.Workbook;if(!s){this._saveFlexGridToWorkbook(u,e,l,!1,null,void 0,i);t?u.saveAsync(t,(function(e){isFunction(o)&&o(e,u)}),r,null):isFunction(o)&&o(null,u);return u}var d=null!=t;this.cancelAsync((function(){var s,c=[e.collectionView&&e.collectionView.collectionChanged,e.columns&&e.columns.collectionChanged,e.rows&&e.rows.collectionChanged,e.resizedColumn,e.resizedRow],removeHandlers=function(){return c.forEach((function(e){e&&e.removeHandler(restart)}))},restart=function(){if(FlexGridXlsxConverter._stopExportsOnGridChange){a._cs&&a._cs.cancel(!1);clearTimeout(s);s=setTimeout((function(){removeHandlers();u=null;a.saveAsync(e,l,t,o,r,n,void 0,i)}),100)}},finish=function(){clearTimeout(s);a._cs=null;removeHandlers()};a._cs=new mXlsx._SyncPromise(null,finish);c.forEach((function(e){e&&e.addHandler(restart)}));a._saveFlexGridToWorkbook(u,e,l,!0,a._cs,(function(e){isFunction(n)&&n(d?Math.round(mXlsx._map(e,0,100,0,50)):e)}),i).then((function(){if(t){u._externalCancellation=function(){return a._cs};u.saveAsync(t,(function(e){finish();isFunction(o)&&o(e,u)}),(function(e){finish();isFunction(r)&&r(e)}),(function(e){isFunction(n)&&n(Math.round(mXlsx._map(e,0,100,51,100)))}))}else{finish();isFunction(n)&&n(100);isFunction(o)&&o(null,u)}}),(function(e){finish();throw e}))}));return null};FlexGridXlsxConverter.cancelAsync=function(e){var l=this;if(this._cs){this._cs.cancel();setTimeout((function(){l._cs=null;isFunction(e)&&e()}),100)}else isFunction(e)&&e()};FlexGridXlsxConverter.load=function(e,l,t){var o=this;if(l instanceof Blob)_blobToBuffer(l,(function(r){l=null;var n=new mXlsx.Workbook;n.load(r,t?t.includeStyles:void 0);r=null;e.deferUpdate((function(){o._loadToFlexGrid(e,n,t);n=null}))}));else if(l instanceof mXlsx.Workbook)e.deferUpdate((function(){o._loadToFlexGrid(e,l,t);l=null}));else{if(!(l instanceof ArrayBuffer||isString(l)))throw"Invalid workbook.";var r=new mXlsx.Workbook;r.load(l,t?t.includeStyles:void 0);l=null;e.deferUpdate((function(){o._loadToFlexGrid(e,r,t);r=null}))}};FlexGridXlsxConverter.loadAsync=function(e,l,t,o,r){var n=this;if(l instanceof Blob)_blobToBuffer(l,(function(s){l=null;var i=new mXlsx.Workbook;i.loadAsync(s,(function(){s=null;e.deferUpdate((function(){n._loadToFlexGrid(e,i,t);o&&o(i);i=null}))}),r,t?t.includeStyles:void 0)}));else if(l instanceof mXlsx.Workbook)e.deferUpdate((function(){n._loadToFlexGrid(e,l,t);o&&o(l);l=null}));else{if(!(l instanceof ArrayBuffer||isString(l)))throw"Invalid workbook.";var s=new mXlsx.Workbook;s.loadAsync(l,(function(){l=null;e.deferUpdate((function(){n._loadToFlexGrid(e,s,t);o&&o(s);s=null}))}),r,t?t.includeStyles:void 0)}};FlexGridXlsxConverter._saveFlexGridToWorkbook=function(e,l,t,o,r,n,s){var i=new mXlsx._SyncPromise(r),a=new mXlsx.WorkSheet,u=!t||null==t.includeColumnHeaders||t.includeColumnHeaders,d=!(!t||null==t.includeRowHeaders)&&t.includeRowHeaders,c=_ExportCellStyles.Cache,f=t?t.includeColumns:null,h=t?t.formatItem:null,m=[],p=t&&null!=t.convertHtmlEntities?asEnum(t.convertHtmlEntities,HtmlEntityConversion):HtmlEntityConversion.Auto;if(t){null!=t.includeCellStyles&&_deprecated("includeCellStyles","includeStyles");c=!1===asBoolean(null!=t.includeStyles?t.includeStyles:t.includeCellStyles,!0)?_ExportCellStyles.None:!1===asBoolean(t.quickCellStyles,!0)?_ExportCellStyles.Regular:_ExportCellStyles.Cache}var x=c===_ExportCellStyles.Cache?new _StyleCache(500):null;null==this.hasCssText&&(this.hasCssText="cssText"in document.body.style);a.name=t?t.sheetName:"";a.visible=!t||!1!==t.sheetVisible;a.rightToLeft=l.rightToLeft;var g,v=l.wj_sheetInfo;if(v&&v.tables&&v.tables.length>0)for(var y=0;y<v.tables.length;y++)a.tables.push(v.tables[y]);if(!v&&(c!==_ExportCellStyles.None||h)){(g=document.createElement("div")).style.visibility="hidden";g.setAttribute(FlexGrid._WJS_MEASURE,"true");l.hostElement.appendChild(g)}var C=d?l.rowHeaders.columns.length:0,w=this._getPerRowColumnsSettings(l,d?[l.topLeftCells,l.columnHeaders]:[l.columnHeaders]),_=w.cols,b=softMultiRow()&&l instanceof softMultiRow().MultiRow?this._getPerRowColumnsSettings(l,d?[l.rowHeaders,l.cells]:[l.cells],l.rowsPerItem).cols:null,S=_.length,T=[[l.topLeftCells,l.columnHeaders],[l.rowHeaders,l.cells],[l.bottomLeftCells,l.columnFooters]];u||T.shift();var X=T.map((function(e){return e[1].rows.length})).reduce((function(e,l){return e+l}));_.length&&_[0].forEach((function(e,l){var t=w.bndCols[0][l];if(!(l>=C&&f)||f(t)){var o=new mXlsx.WorkbookColumn;o._deserialize(e);a._addWorkbookColumn(o)}}));this._saveContentToWorksheet(r,o,Date.now(),0,{panels:T,panelIdx:0,globRowIdx:0,rowsOffset:0,totalRows:X},l,a,d,(function(e){return e==CellType.Cell&&b?b:_}),c,g,m,x,f,p,h,(function(e){n(Math.round(e/X*100))}),(function(){var o=new mXlsx.WorkbookFrozenPane,r=Math.max(0,l.rows._frozenInternal),n=Math.max(0,l.columns._frozenInternal);o.rows=u?r+S:r;o.columns=d?n+C:n;var s=Math.min(l.columns.length,n);if(f)for(var p=0;p<s;p++)f(l.columns[p])||o.columns--;a.frozenPane=o;e._addWorkSheet(a);if(!v&&(c!==_ExportCellStyles.None||h)){l.hostElement.removeChild(g);m.forEach((function(e){return e.forEach((function(e){e&&e.parentElement&&e.parentElement.removeChild(e)}))}))}x&&x.clear();e.activeWorksheet=t?t.activeWorksheet:null;i.resolve()}),s);return i};FlexGridXlsxConverter._saveContentToWorksheet=function(e,l,t,o,r,n,s,i,a,u,d,c,f,h,m,p,x,g,v){for(var y=this,C=v||(u?20:200),_loop_1=function(_){if(e&&e.cancelled)return{value:void 0};if(l&&_-o>C&&Date.now()-t>100){setTimeout((function(){if(!e||!e.cancelled){x(_);y._saveContentToWorksheet(e,l,Date.now(),_,r,n,s,i,a,u,d,c,f,h,m,p,x,g,v)}}),0);return{value:void 0}}for(;_-r.rowsOffset>=r.panels[r.panelIdx][1].rows.length;){r.rowsOffset+=r.panels[r.panelIdx][1].rows.length;r.panelIdx++}var b=r.panels[r.panelIdx],S=b[0],T=b[1],X=_-r.rowsOffset,F=T.rows[X];if(T.cellType!==CellType.Cell&&F.renderSize<=0||F instanceof _NewRowTemplate)return"continue";var k=0,R={},A=new mXlsx.WorkbookRow,G=F instanceof GroupRow,E=0;T.cellType===CellType.Cell&&(G?E=F.level:n.rows.maxGroupLevel>-1&&(E=n.rows.maxGroupLevel+1));var W=a(T.cellType);i&&(k=w._parseFlexGridRowToSheetRow(s,S,R,X,0,W,u,d,c,f,G,E,h,m,p));w._parseFlexGridRowToSheetRow(s,T,R,X,k,W,u,d,c,f,G,E,h,m,p);if(R.cells.length>0){A._deserialize(R);s._addWorkbookRow(A,r.globRowIdx)}r.globRowIdx++},w=this,_=o;_<r.totalRows;_++){var b=_loop_1(_);if("object"==typeof b)return b.value}isFunction(g)&&g()};FlexGridXlsxConverter._loadToFlexGrid=function(e,l,t){if(softTransposedMultiRow()&&e instanceof softTransposedMultiRow().TransposedMultiRow)throw"Not supported.";t=t||{};var o,r=null!=e.wj_sheetInfo,n={},s=[],i=[],a={};e.itemsSource=null;e.columns.clear();e.columnHeaders.rows.clear();e.rows.clear();e.columns._frozenInternal=0;e.rows._frozenInternal=0;var u=null==t.sheetIndex||isNaN(t.sheetIndex)?0:t.sheetIndex;if(u<0||u>=l.sheets.length)throw"The sheet index option is out of the sheet range of current workbook.";if(null!=t.sheetName)for(var d=0;d<l.sheets.length;d++)if(t.sheetName===l.sheets[d].name){o=l.sheets[d];break}if(null!=(o=o||l.sheets[u]).rows){for(var c=this._getColumnCount(o.rows),f=this._getRowCount(o.rows,c),h=o.columns,m=0;m<c;m++){e.columns.push(new Column);if(V=h[m]?h[m]:o._extraColumn){isNaN(+V.width)||(e.columns[m].width=+V.width);V.visible||null==V.visible||(e.columns[m].visible=!!V.visible);V.style&&V.style.wordWrap&&(e.columns[m].wordWrap=V.style.wordWrap)}}var p,x=(null==t.includeColumnHeaders||t.includeColumnHeaders)&&o.rows.length>0,g=!(!t||null==t.includeRowHeaders)&&t.includeRowHeaders,v=x?this._getColumnHeadersHeight(o):0,y=!1,C=[],w=o.frozenPane&&o.frozenPane.rows,_=o.frozenPane&&o.frozenPane.columns;w=isNumber(w)&&!isNaN(w)?w:null;_=isNumber(_)&&!isNaN(_)?_:null;for(var b=v;b<f;b++){var S=!1,T=null,X=o.rows[b];if(X)for(var F=b+1;F<o.rows.length;){var k=o.rows[F];if(k){(isNaN(X.groupLevel)&&!isNaN(k.groupLevel)||!isNaN(X.groupLevel)&&X.groupLevel<k.groupLevel)&&(S=!0);break}F++}if(S&&!o.summaryBelow){p&&(p.isCollapsed=y);(p=new GroupRow).isReadOnly=!1;y=null!=X.collapsed&&X.collapsed;p.level=isNaN(X.groupLevel)?0:X.groupLevel;a[p.level]=y;this._checkParentCollapsed(a,p.level)&&p._setFlag(RowColFlags.ParentCollapsed,!0);e.rows.push(p)}else{var R=new Row;X&&this._checkParentCollapsed(a,X.groupLevel)&&R._setFlag(RowColFlags.ParentCollapsed,!0);e.rows.push(R)}X&&X.height&&!isNaN(X.height)&&(e.rows[b-v].height=X.height);for(m=0;m<c;m++)if(X){var A=X.cells[m],G=A?A.formula:null;G&&"="!==G[0]&&(G="="+G);if(A&&A.textRuns&&A.textRuns.length>0){e.rows[b-v].isContentHtml=!0;e.setCellData(b-v,m,this._parseTextRunsToHTML(A.textRuns))}else{var E=G&&r?G:this._getItemValue(A);e.setCellData(b-v,m,E,""!=E)}S||this._setColumn(C,m,A);var W=b*c+m,H=A?A.style:null;if(H){T=null==T?!!H.wordWrap:T&&!!H.wordWrap;if(r){var I=mXlsx.Workbook._parseExcelFormat(A),M=void 0;if(H.hAlign)M=mXlsx.Workbook._parseHAlignToString(asEnum(H.hAlign,mXlsx.HAlign));else switch(this._getItemType(A)){case DataType.Number:M="right";break;case DataType.Boolean:M="center";break;default:M=I&&0===I.search(/[n,c,p]/i)?"right":"left"}n[W]={fontWeight:H.font&&H.font.bold?"bold":"none",fontStyle:H.font&&H.font.italic?"italic":"none",textDecoration:H.font&&H.font.underline?"underline":"none",textAlign:M,fontFamily:H.font&&H.font.family?H.font.family:"",fontSize:H.font&&H.font.size?H.font.size+"px":"",color:H.font&&H.font.color?H.font.color:"",backgroundColor:H.fill&&H.fill.color?H.fill.color:"",whiteSpace:H.wordWrap?"pre-wrap":"normal",format:I};if(H.borders){if(H.borders.left){this._parseBorderStyle(H.borders.left.style,"Left",n[W]);n[W].borderLeftColor=H.borders.left.color}if(H.borders.right){this._parseBorderStyle(H.borders.right.style,"Right",n[W]);n[W].borderRightColor=H.borders.right.color}if(H.borders.top){this._parseBorderStyle(H.borders.top.style,"Top",n[W]);n[W].borderTopColor=H.borders.top.color}if(H.borders.bottom){this._parseBorderStyle(H.borders.bottom.style,"Bottom",n[W]);n[W].borderBottomColor=H.borders.bottom.color}}if(H.fill&&H.fill.color){var N=n[W],B=H.borders,D=H.fill.color;if(B){B.left&&B.left.color||(N.borderLeftColor=D);B.right&&B.right.color||m===_-1||(N.borderRightColor=D);B.top&&B.top.color||(N.borderTopColor=D);B.bottom&&B.bottom.color||b===w-1||(N.borderBottomColor=D)}else{N.borderLeftColor=D;m!==_-1&&(N.borderRightColor=D);N.borderTopColor=D;b!==w-1&&(N.borderBottomColor=D)}}H.font&&-1===i.indexOf(H.font.family)&&i.push(H.font.family)}}r&&A&&isNumber(A.rowSpan)&&A.rowSpan>0&&isNumber(A.colSpan)&&A.colSpan>0&&(A.rowSpan>1||A.colSpan>1)&&s.push(new CellRange(b,m,b+A.rowSpan-1,m+A.colSpan-1))}if(X){this._checkParentCollapsed(a,X.groupLevel)||X.visible||null==X.visible||(e.rows[b-v].visible=X.visible);e.rows[b-v].wordWrap=!!X.style&&!!X.style.wordWrap||!!T}}p&&(p.isCollapsed=y);null!=_&&(e.columns._frozenInternal=g&&_>0?_-1:_);null!=w&&(e.rows._frozenInternal=x&&w>0?w-1:w);for(m=0;m<e.columnHeaders.columns.length;m++){var z=C[m],L=e.columns[m];L.isRequired=!1;if(z){z.dataType===DataType.Boolean&&(L.dataType=z.dataType);L.format=z.format;L.align=z.hAlign;L.wordWrap=L.wordWrap||!!z.wordWrap}}for(d=0;d<Math.max(v,1);d++)e.columnHeaders.rows.push(new Row);for(d=0;d<v;d++)for(var O=0;O<e.columnHeaders.columns.length;O++){var P=o.rows[d]?o.rows[d].cells[O]:null,j=P&&null!=P.value?P.value:"",V=e.columnHeaders.columns[O];if(j){var U=mXlsx.Workbook._parseExcelFormat(P);j=Globalize.format(j,U)}V.header=V.header||j;e.columnHeaders.setCellData(d,O,j)}if(r){var Y=null!=t.sheetVisible?t.sheetVisible:!1!==o.visible;e.wj_sheetInfo.name=o.name;e.wj_sheetInfo.visible=Y;e.wj_sheetInfo.styledCells=n;e.wj_sheetInfo.mergedRanges=s;e.wj_sheetInfo.fonts=i;e.wj_sheetInfo.tables=o.tables}}};FlexGridXlsxConverter._getColumnHeadersHeight=function(e){var l;if(!e||!(l=e.rows).length)return 0;if(!l[0])return 1;for(var t=0,o=1;t<l.length&&o>0;t++,o--){var r=l[t].cells.reduce((function(e,l){return Math.max(e,l.rowSpan||0)}),1);r>o&&(o=r)}return t};FlexGridXlsxConverter._escapePlainText=function(e){return null==e?"":""===e?"'":"'"===e[0]||e.length>1&&"="===e[0]&&"="===e[1]?"'"+e:e};FlexGridXlsxConverter._parseFlexGridRowToSheetRow=function(e,l,t,o,r,n,s,i,a,u,d,c,f,h,m){var p=l.grid,x=p.wj_sheetInfo,g=l.rows[o],v=0,y=x&&x.evaluateFormula;null==g.recordIndex?l.cellType===CellType.ColumnHeader&&l.rows.length>1&&(v=Math.min(o,n.length-1)):v=g.recordIndex;t.cells||(t.cells=[]);t.visible=g.isVisible;t.height=t.visible?g.renderHeight||l.rows.defaultSize:g.height;t.groupLevel=c;var C=null;if(d){t.collapsed=g.isCollapsed;C=g instanceof GroupRow?g:null}var w=C&&(p.groupSummaryPosition===GroupSummaryPosition.Bottom||p.groupSummaryPosition===GroupSummaryPosition.Auto&&!C.isCollapsed),_=C&&!C.isSummary&&w;g.wordWrap&&(t.style={wordWrap:g.wordWrap});for(var b,S=g.constructor===Row||g.constructor===_NewRowTemplate||softTransposed()&&p instanceof softTransposed().TransposedGrid&&g instanceof Row||softDetail()&&g.constructor===softDetail().DetailRow||softMultiRow()&&g.constructor===softMultiRow()._MultiRow||softTransposedMultiRow()&&g instanceof softTransposedMultiRow()._MultiRow,T=softDetail()&&g.constructor===softDetail().DetailRow,X=0,F=Math.round(mXlsx._xlsx._parsePixelToCharWidth(p.treeIndent)||0),getTreeIndent=function(e){return e*F},k=!1;X<l.columns.length;X++){var R=void 0,A=void 0,G=void 0,E=1,W=1,H=!1,I=p._getBindingColumn(l,o,l.columns[X]),M=0;if(x&&l===p.cells){var N=o*l.columns.length+X;x.mergedRanges&&(R=this._getMergedRange(o,X,x.mergedRanges));x.styledCells&&(A=x.styledCells[N])}else if(s!==_ExportCellStyles.None){G=this._getMeasureCell(l,X,i,a);A=(R=p.getMergedRangeRawData(l,o,X,!1))?this._getCellStyle(l,G,R.bottomRow,R.rightCol,u,!!m)||{}:this._getCellStyle(l,G,o,X,u,!!m)||{}}R||(R=p.getMergedRangeRawData(l,o,X,!1));if(R){if(o===R.topRow&&X===R.leftCol){W=R.bottomRow-R.topRow+1;E=this._getColSpan(l,R,f);H=!0}if(X>R.leftCol&&X<=R.rightCol&&k){H=!0;k=!1;E=R.rightCol-X+1}}else H=!0;if(!f||f(I)){var B=n[v]?n[v][X+r]:null,D=void 0,z=void 0,L=void 0,O=void 0,P=void 0,j=void 0,V=void 0;if(S||d){L=H?l.getCellData(o,X,!0):null;O=H?l.getCellData(o,X,!1):null;z=this._isFormula(L);D=null;P=isDate(O);if(l.cellType===CellType.ColumnHeader&&isString(L))V="General";else if(A&&A.format){j=A.format;/[hsmyt\:]/i.test(j={d:"M/d/yyyy",D:"dddd, MMMM dd, yyyy"}[j]||j)&&(P=!0);V=mXlsx.Workbook._parseCellFormat(A.format,P)}else if(B&&B.style&&B.style.format){j=I.format;V=B.style.format}else V=null;z&&null!=y&&isFunction(y)&&(D=y(L));if(!V)if(P)V="m/d/yyyy";else if(isNumber(O)&&!I.dataMap)V=isInt(O)?"#,##0":"#,##0.00";else if(z){var U=L.toLowerCase();if(U.indexOf("now()")>-1){V="m/d/yyyy h:mm";P=!0}else if(U.indexOf("today()")>-1||U.indexOf("date(")>-1){V="m/d/yyyy";P=!0}else if(U.indexOf("time(")>-1){V="h:mm AM/PM";P=!0}}else V="General"}else{L=H?p.columnHeaders.getCellData(0,X,!0):null;V="General"}var Y=void 0;if(isString(L)&&"{"!==L[0]&&-1!==L.indexOf("<span")){Y=this._parseToTextRuns(L);L=null}var q=this._parseCellStyle(A)||{};if(l===p.cells&&d&&g.hasChildren&&X===p.columns.firstVisibleIndex){var J=void 0;if(z&&null!=D)J=D;else{L?J=L:H&&(J=g.getGroupHeader());J&&(J=J.replace(/<\/?\w+>/g,"").replace(/&#39;/g,"'"))}if(null==J&&!A)continue;!(P=isDate(J))&&j&&"d"===j.toLowerCase()&&isInt(J)&&(V="0");J=isString(J)?mXlsx.Workbook._unescapeXML(J):J;X===p.columns.firstVisibleIndex&&p.treeIndent&&(M=getTreeIndent(c));b={value:J,isDate:P,formula:z?this._parseToExcelFormula(L,P):null,colSpan:E,rowSpan:W,style:this._extend(q,{format:V,font:p.childItemsPath?{}:{bold:!0},hAlign:e.rightToLeft?mXlsx.HAlign.Right:mXlsx.HAlign.Left,indent:M}),textRuns:Y}}else{if(_){L=null;O=null}if(d||h===HtmlEntityConversion.Auto&&I.isContentHtml||h===HtmlEntityConversion.Yes){L=isString(L)?mXlsx.Workbook._unescapeXML(L):L;O=isString(O)?mXlsx.Workbook._unescapeXML(O):O}!P&&j&&"d"===j.toLowerCase()&&isInt(O)&&(V="0");var K=void 0,$=void 0;K=q&&q.hAlign?q.hAlign:B&&B.style&&null!=B.style.hAlign?asEnum(B.style.hAlign,mXlsx.HAlign,!0):isDate(O)?mXlsx.HAlign.Left:mXlsx.HAlign.General;l===p.cells&&X===p.columns.firstVisibleIndex&&p.treeIndent&&(e.rightToLeft&&K===mXlsx.HAlign.Right||!e.rightToLeft&&K===mXlsx.HAlign.Left||K===mXlsx.HAlign.General)&&(M=getTreeIndent(c));A&&A.verticalAlign&&($=mXlsx.Workbook._parseStringToVAlign(A.verticalAlign));b={value:z?D:"General"!==V||""===L&&null==O||!0===O||!1===O?this._escapePlainText(O):this._escapePlainText(L),isDate:P,formula:z?this._parseToExcelFormula(L,P):null,colSpan:X<p.columns.firstVisibleIndex?1:E,rowSpan:W,style:this._extend(q,{format:V,hAlign:K,vAlign:void 0!==$?$:W>1?l===p.cells||!1===p.centerHeadersVertically?mXlsx.VAlign.Top:mXlsx.VAlign.Center:null,indent:M}),textRuns:Y}}if(m){m(new XlsxFormatItemEventArgs(l,new CellRange(o,X),G,i,a,u,b))}if(T){var Q=l.getCellElement(o,X);if(Q){var Z=g.detail;Q.appendChild(Z);Control.refreshAll(Z)}}t.cells.push(b)}else k=H}return r+X};FlexGridXlsxConverter._parseCellStyle=function(e,l){void 0===l&&(l=!1);if(null==e)return null;var t=e.fontSize;t=t?+t.substring(0,t.indexOf("px")):null;isNaN(t)&&(t=null);var o=e.whiteSpace;o=!!o&&o.indexOf("pre")>-1;var r=e.textAlign;"start"===r&&(r="rtl"===e.direction?"right":"left");"end"===r&&(r="rtl"===e.direction?"left":"right");return{font:{bold:"bold"===e.fontWeight||+e.fontWeight>=700,italic:"italic"===e.fontStyle,underline:"underline"===(e.textDecorationStyle||e.textDecoration),family:this._parseToExcelFontFamily(e.fontFamily),size:t,color:e.color},fill:{color:e.backgroundColor},borders:this._parseBorder(e,l),hAlign:mXlsx.Workbook._parseStringToHAlign(r),wordWrap:o}};FlexGridXlsxConverter._parseBorder=function(e,l){var t={left:this._parseEgdeBorder(e,"Left"),right:this._parseEgdeBorder(e,"Right"),top:this._parseEgdeBorder(e,"Top"),bottom:this._parseEgdeBorder(e,"Bottom")};if(l){t.vertical=this._parseEgdeBorder(e,"Vertical");t.horizontal=this._parseEgdeBorder(e,"Horizontal")}return t};FlexGridXlsxConverter._parseEgdeBorder=function(e,l){var t,o=e["border"+l+"Style"],r=e["border"+l+"Width"];r&&(r=parseFloat(r));if(o&&"none"!==o&&"hidden"!==o&&0!==r){t={};switch(o=o.toLowerCase()){case"dotted":t.style=r>1?mXlsx.BorderStyle.MediumDashDotted:mXlsx.BorderStyle.Dotted;break;case"dashed":t.style=r>1?mXlsx.BorderStyle.MediumDashed:mXlsx.BorderStyle.Dashed;break;case"double":t.style=mXlsx.BorderStyle.Double;break;default:t.style=r>2?mXlsx.BorderStyle.Thick:r>1?mXlsx.BorderStyle.Medium:mXlsx.BorderStyle.Thin}t.color=e["border"+l+"Color"]}return t};FlexGridXlsxConverter._parseBorderStyle=function(e,l,t){var o="border"+l+"Style",r="border"+l+"Width";switch(e){case mXlsx.BorderStyle.Dotted:case mXlsx.BorderStyle.Hair:t[o]="dotted";t[r]="1px";break;case mXlsx.BorderStyle.Dashed:case mXlsx.BorderStyle.ThinDashDotDotted:case mXlsx.BorderStyle.ThinDashDotted:t[o]="dashed";t[r]="1px";break;case mXlsx.BorderStyle.MediumDashed:case mXlsx.BorderStyle.MediumDashDotDotted:case mXlsx.BorderStyle.MediumDashDotted:case mXlsx.BorderStyle.SlantedMediumDashDotted:t[o]="dashed";t[r]="2px";break;case mXlsx.BorderStyle.Double:t[o]="double";t[r]="3px";break;case mXlsx.BorderStyle.Medium:t[o]="solid";t[r]="2px";break;case mXlsx.BorderStyle.Thick:t[o]="solid";t[r]="3px";break;default:t[o]="solid";t[r]="1px"}};FlexGridXlsxConverter._parseToExcelFontFamily=function(e){var l;e&&(l=e.split(","))&&l.length>0&&(e=l[0].replace(/\"|\'/g,""));return e};FlexGridXlsxConverter._parseToExcelFormula=function(e,l){var t=e.match(/(floor|ceiling)\([+-]?\d+\.?\d*\)/gi);if(t)for(var o=0;o<t.length;o++){var r=(s=t[o]).substring(0,s.lastIndexOf(")"))+", 1)";e=e.replace(s,r)}t=null;if(t=e.match(/text\(\"?\w+\"?\s*\,\s*\"\w+\"\)/gi)){var n=/\"?\w+\"?\s*\,\s*\"(\w+)\"/i;for(o=0;o<t.length;o++){var s,i=(s=t[o]).match(n);if(i&&2===i.length){var a=i[1];if(!/^d{1,4}?$/.test(a)){var u=mXlsx.Workbook._parseCellFormat(a,l);r=s.replace(a,u);e=e.replace(s,r)}}}}return e};FlexGridXlsxConverter._parseToTextRuns=function(e){for(var l=e.split("<span "),t=[],o=0;o<l.length;o++){var r=l[o],n=void 0;if(-1!==r.indexOf("</span>")){n={text:r.substring(r.indexOf(">")+1,r.indexOf("</span>")),font:this._parseToTextRunFont(r.substring(r.indexOf('style="')+7,r.indexOf(';"')))}}else n={text:r};t.push(n)}return t};FlexGridXlsxConverter._parseToTextRunFont=function(e){var l,t=e.split(";");if(t.length>0){for(var o=void 0,r=void 0,n=void 0,s=void 0,i=void 0,a=void 0,u=0;u<t.length;u++){var d=t[u].split(":");if(2===d.length){d[1]=d[1].trim();switch(d[0]){case"font-size":s=+d[1].substring(0,d[1].indexOf("px"));isNaN(s)&&(s=null);break;case"font-weight":o="bold"===d[1]||+d[1]>=700;break;case"font-style":r="italic"===d[1];break;case"text-decoration-style":case"text-decoration":n="underline"===d[1];break;case"font-family":i=this._parseToExcelFontFamily(d[1]);break;case"color":a=d[1]}}}l={bold:o,italic:r,underline:n,family:i,size:s,color:a}}return l};FlexGridXlsxConverter._getMeasureCell=function(e,l,t,o){var r=o[e.cellType],n=r&&r[l],s=null==n;if(n){if(this.hasCssText){n.style.cssText="";n.style.visibility="hidden"}}else{r||(o[e.cellType]=r=[]);r[l]=n=t.cloneNode()}!s&&n.parentElement||(e.hostElement.children.length>0?e.hostElement.children[0].appendChild(n):e.hostElement.appendChild(n));return n};FlexGridXlsxConverter._getColumnSetting=function(e,l,t){var o=e;null!=e.colspan&&(o=this._getRenderColumn(l,t));return o?{autoWidth:!0,width:o.visible?o.renderWidth||t.defaultSize:o.width,visible:o.visible&&0!==o.width&&!o._getFlag(RowColFlags.ParentCollapsed),style:{format:e.format?mXlsx.Workbook._parseCellFormat(e.format,e.dataType===DataType.Date):"",hAlign:mXlsx.Workbook._parseStringToHAlign(this._toExcelHAlign(o.getAlignment())),wordWrap:o.wordWrap}}:null};FlexGridXlsxConverter._getPerRowColumnsSettings=function(e,l,t){var o=this,r=[],n=[];l.forEach((function(s,i){for(var a=0,u=i>0?l[0].columns.length:0,_loop_2=function(l){if(null!=t&&l>=t)return"break";if(s.rows[l].renderSize<=0)return"continue";r[a]=r[a]||[];n[a]=n[a]||[];s.columns.forEach((function(t,i){var d=e._getBindingColumn(s,l,t),c=o._getColumnSetting(d,i,s.columns);if(c){r[a][u+i]=c;n[a][u+i]=d}}));a++},d=0;d<s.rows.length;d++){if("break"===_loop_2(d))break}}));return{cols:r,bndCols:n}};FlexGridXlsxConverter._toExcelHAlign=function(e){return(e=e?e.trim().toLowerCase():e)?e.indexOf("center")>-1?"center":e.indexOf("right")>-1||e.indexOf("end")>-1?"right":e.indexOf("justify")>-1?"justify":"left":e};FlexGridXlsxConverter._getColumnCount=function(e){for(var l=0,t=[],o=0;o<e.length;o++){var r=e[o]&&e[o].cells?e[o].cells:[];if(r&&r.length>0){var n=r.length;isInt(r[n-1].colSpan)&&r[n-1].colSpan>1&&(n=n+r[n-1].colSpan-1);if(r[n-1]&&r[n-1].formula){var s=r[n-1].formula.match(cellCoordinateParserRegex);if(s)for(var i=0,a=s;i<a.length;i++){var u=a[i];t.push(mXlsx.Workbook.tableAddress(u))}}n>l&&(l=n)}}return l};FlexGridXlsxConverter._getRowCount=function(e,l){for(var t=e.length,o=t-1,r=0;r<l;r++)e:for(;o>=0;o--){var n=e[o],s=(n&&n.cells?n.cells:[])[r];if(s&&(null!=s.value&&""!==s.value||isInt(s.rowSpan)&&s.rowSpan>1)){isInt(s.rowSpan)&&s.rowSpan>1&&o+s.rowSpan>t&&(t=o+s.rowSpan);break e}}return t};FlexGridXlsxConverter._numAlpha=function(e){var l=Math.floor(e/26)-1;return(l>-1?this._numAlpha(l):"")+String.fromCharCode(65+e%26)};FlexGridXlsxConverter._getItemType=function(e){return null==e||null==e.value||isNaN(e.value)?null:getType(e.value)};FlexGridXlsxConverter._setColumn=function(e,l,t){var o=e[l],r=this._getItemType(t);r===DataType.Boolean&&t.formula&&(r=null);if(o){o.dataType!==r&&o.dataType===DataType.Boolean&&r!==DataType.Boolean&&(o.dataType=r);if(t&&null!=t.value&&(!isString(t.value)||!isNullOrWhiteSpace(t.value))){var n=mXlsx.Workbook._parseExcelFormat(t);n&&o.format!==n&&"General"!==n&&(o.format=n)}var s=void 0,i=void 0;if(t&&t.style){t.style.hAlign&&(s=mXlsx.Workbook._parseHAlignToString(asEnum(t.style.hAlign,mXlsx.HAlign)));t.style.vAlign&&(i=mXlsx.Workbook._parseVAlignToString(asEnum(t.style.vAlign,mXlsx.VAlign)));null==o.wordWrap?o.wordWrap=!!t.style.wordWrap:o.wordWrap=o.wordWrap&&!!t.style.wordWrap}s||r!==DataType.Number||(s="right");o.hAlign=s;o.vAlign=i}else e[l]={dataType:r,format:mXlsx.Workbook._parseExcelFormat(t),hAlign:"",vAlign:"",wordWrap:null}};FlexGridXlsxConverter._getItemValue=function(e){if(null==e||null==e.value)return null;var l=e.value;isString(l)&&"'"===l[0]&&(l=l.substr(1));return isNumber(l)&&isNaN(l)?"":l instanceof Date&&isNaN(l.getTime())?"":l};FlexGridXlsxConverter._getCellStyle=function(e,l,t,o,r,n){var s,i=e.grid;try{var a=!(r&&!i.formatItem.hasHandlers&&!i.itemFormatter&&!n);i.cellFactory.updateCell(e,t,o,l,null,a);l.className=l.className.replace("wj-state-selected","");l.className=l.className.replace("wj-state-multi-selected","")}catch(e){return null}if(r){var u=e.hostElement,d=l,c=d.style.cssText.split(/;\s+/).filter((function(e){var l=e.substring(0,e.indexOf(":"));return/^(color|background|border|font|text|whitespace)/i.test(l)})).join(";");do{c=d.className+c}while(d!==u&&(d=d.parentElement));if(!(s=r.getValue(c))){s=window.getComputedStyle(l);r.add(c,s)}}else s=window.getComputedStyle(l);return s};FlexGridXlsxConverter._parseTextRunsToHTML=function(e){for(var l="",t=0;t<e.length;t++){var o=e[t],r=o.font;l+=r?'<span style="'+(r.bold?"font-weight: bold;":"")+(r.italic?"font-style: italic;":"")+(r.underline?"text-decoration: underline;":"")+(r.family?"font-family: "+r.family+";":"")+(null!=r.size?"font-size: "+r.size+"px;":"")+(r.color?"color: "+r.color+";":"")+'">'+o.text+"</span>":o.text}return l};FlexGridXlsxConverter._extend=function(e,l){for(var t in l){var o=l[t];isObject(o)&&e[t]?copy(e[t],o):e[t]=o}return e};FlexGridXlsxConverter._checkParentCollapsed=function(e,l){var t=!1;Object.keys(e).forEach((function(o){!0===e[o]&&!1===t&&!isNaN(l)&&+o<l&&(t=!0)}));return t};FlexGridXlsxConverter._getColSpan=function(e,l,t){for(var o=0,r=l.leftCol;r<=l.rightCol;r++)t&&!t(e.columns[r])||o++;return o};FlexGridXlsxConverter._getRenderColumn=function(e,l){return e>=l.length?null:l[e]};FlexGridXlsxConverter._getMergedRange=function(e,l,t){for(var o=0;o<t.length;o++){var r=t[o];if(e>=r.topRow&&e<=r.bottomRow&&l>=r.leftCol&&l<=r.rightCol)return r}return null};FlexGridXlsxConverter._isFormula=function(e){return e&&"string"==typeof e&&e.length>1&&"="===e[0]&&"="!==e[1]};FlexGridXlsxConverter._stopExportsOnGridChange=!0;return FlexGridXlsxConverter}();export{FlexGridXlsxConverter};var _ExportCellStyles,XlsxFormatItemEventArgs=function(e){__extends(XlsxFormatItemEventArgs,e);function XlsxFormatItemEventArgs(l,t,o,r,n,s,i){var a=e.call(this,l,t)||this;a._cell=o;a._patternCell=r;a._xlsxCell=i;a._cellsCache=n;a._styleCache=s;return a}Object.defineProperty(XlsxFormatItemEventArgs.prototype,"cell",{get:function(){return this._cell},enumerable:!0,configurable:!0});Object.defineProperty(XlsxFormatItemEventArgs.prototype,"xlsxCell",{get:function(){return this._xlsxCell},set:function(e){this._xlsxCell=e},enumerable:!0,configurable:!0});XlsxFormatItemEventArgs.prototype.getFormattedCell=function(){if(!this._cell){this._cell=FlexGridXlsxConverter._getMeasureCell(this.panel,this.col,this._patternCell,this._cellsCache);FlexGridXlsxConverter._getCellStyle(this.panel,this._cell,this.row,this.col,this._styleCache,!0)}return this._cell};return XlsxFormatItemEventArgs}(CellRangeEventArgs);export{XlsxFormatItemEventArgs};!function(e){e[e.None=0]="None";e[e.Regular=1]="Regular";e[e.Cache=2]="Cache"}(_ExportCellStyles||(_ExportCellStyles={}));var _StyleCache=function(){function _StyleCache(e){this._cache={};this._size=0;this._max=e}_StyleCache.prototype.add=function(e,l){this._size>=this._max&&this.clear();this._cache[e]=this._cloneStyle(l);this._size++};_StyleCache.prototype.clear=function(){this._cache={};this._size=0};_StyleCache.prototype.getValue=function(e){return this._cache[e]||null};_StyleCache.prototype.hasKey=function(e){return!!this._cache[e]};_StyleCache.prototype._cloneStyle=function(e){if(!e)return null;for(var l={},toCamel=function(e){return e.replace(/\-([a-z])/g,(function(e,l,t){return t>0?l.toUpperCase():l}))},t=0,o=e.length;t<o;t++){var r=e[t];l[toCamel(r)]=e.getPropertyValue(r)}return l};return _StyleCache}();export{_StyleCache};export function _blobToBuffer(e,l){if(e&&l)if(e.arrayBuffer)e.arrayBuffer().then((function(e){return l(e)}));else{var t=new FileReader;t.onload=function(){l(t.result);t=null};t.readAsArrayBuffer(e)}}export var HtmlEntityConversion;!function(e){e[e.Auto=0]="Auto";e[e.No=1]="No";e[e.Yes=2]="Yes"}(HtmlEntityConversion||(HtmlEntityConversion={}));_registerModule("wijmo.grid.xlsx",selfModule);