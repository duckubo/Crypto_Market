/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(e,o){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,o){e.__proto__=o}||function(e,o){for(var t in o)o.hasOwnProperty(t)&&(e[t]=o[t])})(e,o)};return function(e,o){extendStatics(e,o);function __(){this.constructor=e}e.prototype=null===o?Object.create(o):(__.prototype=o.prototype,new __)}}(),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)Object.hasOwnProperty.call(e,t)&&(o[t]=e[t]);o.default=e;return o};Object.defineProperty(exports,"__esModule",{value:!0});var wijmo_1=require("@mescius/wijmo"),wijmo_grid_1=require("@mescius/wijmo.grid"),mXlsx=__importStar(require("@mescius/wijmo.xlsx")),selfModule=__importStar(require("@mescius/wijmo.grid.xlsx"));function softDetail(){return wijmo_1._getModule("wijmo.grid.detail")}exports.softDetail=softDetail;function softMultiRow(){return wijmo_1._getModule("wijmo.grid.multirow")}exports.softMultiRow=softMultiRow;function softTransposed(){return wijmo_1._getModule("wijmo.grid.transposed")}exports.softTransposed=softTransposed;function softTransposedMultiRow(){return wijmo_1._getModule("wijmo.grid.transposedmultirow")}exports.softTransposedMultiRow=softTransposedMultiRow;var FlexGridXlsxConverter=function(){function FlexGridXlsxConverter(){}FlexGridXlsxConverter.save=function(e,o,t,l){var r=new mXlsx.Workbook;this._saveFlexGridToWorkbook(r,e,o,!1,null,void 0,l);t&&r.save(t);return r};FlexGridXlsxConverter.saveAsync=function(e,o,t,l,r,n,i,s){var a=this,u=new mXlsx.Workbook;if(!i){this._saveFlexGridToWorkbook(u,e,o,!1,null,void 0,s);t?u.saveAsync(t,(function(e){wijmo_1.isFunction(l)&&l(e,u)}),r,null):wijmo_1.isFunction(l)&&l(null,u);return u}var d=null!=t;this.cancelAsync((function(){var i,c=[e.collectionView&&e.collectionView.collectionChanged,e.columns&&e.columns.collectionChanged,e.rows&&e.rows.collectionChanged,e.resizedColumn,e.resizedRow],removeHandlers=function(){return c.forEach((function(e){e&&e.removeHandler(restart)}))},restart=function(){if(FlexGridXlsxConverter._stopExportsOnGridChange){a._cs&&a._cs.cancel(!1);clearTimeout(i);i=setTimeout((function(){removeHandlers();u=null;a.saveAsync(e,o,t,l,r,n,void 0,s)}),100)}},finish=function(){clearTimeout(i);a._cs=null;removeHandlers()};a._cs=new mXlsx._SyncPromise(null,finish);c.forEach((function(e){e&&e.addHandler(restart)}));a._saveFlexGridToWorkbook(u,e,o,!0,a._cs,(function(e){wijmo_1.isFunction(n)&&n(d?Math.round(mXlsx._map(e,0,100,0,50)):e)}),s).then((function(){if(t){u._externalCancellation=function(){return a._cs};u.saveAsync(t,(function(e){finish();wijmo_1.isFunction(l)&&l(e,u)}),(function(e){finish();wijmo_1.isFunction(r)&&r(e)}),(function(e){wijmo_1.isFunction(n)&&n(Math.round(mXlsx._map(e,0,100,51,100)))}))}else{finish();wijmo_1.isFunction(n)&&n(100);wijmo_1.isFunction(l)&&l(null,u)}}),(function(e){finish();throw e}))}));return null};FlexGridXlsxConverter.cancelAsync=function(e){var o=this;if(this._cs){this._cs.cancel();setTimeout((function(){o._cs=null;wijmo_1.isFunction(e)&&e()}),100)}else wijmo_1.isFunction(e)&&e()};FlexGridXlsxConverter.load=function(e,o,t){var l=this;if(o instanceof Blob)_blobToBuffer(o,(function(r){o=null;var n=new mXlsx.Workbook;n.load(r,t?t.includeStyles:void 0);r=null;e.deferUpdate((function(){l._loadToFlexGrid(e,n,t);n=null}))}));else if(o instanceof mXlsx.Workbook)e.deferUpdate((function(){l._loadToFlexGrid(e,o,t);o=null}));else{if(!(o instanceof ArrayBuffer||wijmo_1.isString(o)))throw"Invalid workbook.";var r=new mXlsx.Workbook;r.load(o,t?t.includeStyles:void 0);o=null;e.deferUpdate((function(){l._loadToFlexGrid(e,r,t);r=null}))}};FlexGridXlsxConverter.loadAsync=function(e,o,t,l,r){var n=this;if(o instanceof Blob)_blobToBuffer(o,(function(i){o=null;var s=new mXlsx.Workbook;s.loadAsync(i,(function(){i=null;e.deferUpdate((function(){n._loadToFlexGrid(e,s,t);l&&l(s);s=null}))}),r,t?t.includeStyles:void 0)}));else if(o instanceof mXlsx.Workbook)e.deferUpdate((function(){n._loadToFlexGrid(e,o,t);l&&l(o);o=null}));else{if(!(o instanceof ArrayBuffer||wijmo_1.isString(o)))throw"Invalid workbook.";var i=new mXlsx.Workbook;i.loadAsync(o,(function(){o=null;e.deferUpdate((function(){n._loadToFlexGrid(e,i,t);l&&l(i);i=null}))}),r,t?t.includeStyles:void 0)}};FlexGridXlsxConverter._saveFlexGridToWorkbook=function(e,o,t,l,r,n,i){var s=new mXlsx._SyncPromise(r),a=new mXlsx.WorkSheet,u=!t||null==t.includeColumnHeaders||t.includeColumnHeaders,d=!(!t||null==t.includeRowHeaders)&&t.includeRowHeaders,c=_ExportCellStyles.Cache,f=t?t.includeColumns:null,m=t?t.formatItem:null,h=[],_=t&&null!=t.convertHtmlEntities?wijmo_1.asEnum(t.convertHtmlEntities,HtmlEntityConversion):HtmlEntityConversion.Auto;if(t){null!=t.includeCellStyles&&wijmo_1._deprecated("includeCellStyles","includeStyles");c=!1===wijmo_1.asBoolean(null!=t.includeStyles?t.includeStyles:t.includeCellStyles,!0)?_ExportCellStyles.None:!1===wijmo_1.asBoolean(t.quickCellStyles,!0)?_ExportCellStyles.Regular:_ExportCellStyles.Cache}var p=c===_ExportCellStyles.Cache?new _StyleCache(500):null;null==this.hasCssText&&(this.hasCssText="cssText"in document.body.style);a.name=t?t.sheetName:"";a.visible=!t||!1!==t.sheetVisible;a.rightToLeft=o.rightToLeft;var x,g=o.wj_sheetInfo;if(g&&g.tables&&g.tables.length>0)for(var w=0;w<g.tables.length;w++)a.tables.push(g.tables[w]);if(!g&&(c!==_ExportCellStyles.None||m)){(x=document.createElement("div")).style.visibility="hidden";x.setAttribute(wijmo_grid_1.FlexGrid._WJS_MEASURE,"true");o.hostElement.appendChild(x)}var v=d?o.rowHeaders.columns.length:0,y=this._getPerRowColumnsSettings(o,d?[o.topLeftCells,o.columnHeaders]:[o.columnHeaders]),C=y.cols,b=softMultiRow()&&o instanceof softMultiRow().MultiRow?this._getPerRowColumnsSettings(o,d?[o.rowHeaders,o.cells]:[o.cells],o.rowsPerItem).cols:null,S=C.length,T=[[o.topLeftCells,o.columnHeaders],[o.rowHeaders,o.cells],[o.bottomLeftCells,o.columnFooters]];u||T.shift();var X=T.map((function(e){return e[1].rows.length})).reduce((function(e,o){return e+o}));C.length&&C[0].forEach((function(e,o){var t=y.bndCols[0][o];if(!(o>=v&&f)||f(t)){var l=new mXlsx.WorkbookColumn;l._deserialize(e);a._addWorkbookColumn(l)}}));this._saveContentToWorksheet(r,l,Date.now(),0,{panels:T,panelIdx:0,globRowIdx:0,rowsOffset:0,totalRows:X},o,a,d,(function(e){return e==wijmo_grid_1.CellType.Cell&&b?b:C}),c,x,h,p,f,_,m,(function(e){n(Math.round(e/X*100))}),(function(){var l=new mXlsx.WorkbookFrozenPane,r=Math.max(0,o.rows._frozenInternal),n=Math.max(0,o.columns._frozenInternal);l.rows=u?r+S:r;l.columns=d?n+v:n;var i=Math.min(o.columns.length,n);if(f)for(var _=0;_<i;_++)f(o.columns[_])||l.columns--;a.frozenPane=l;e._addWorkSheet(a);if(!g&&(c!==_ExportCellStyles.None||m)){o.hostElement.removeChild(x);h.forEach((function(e){return e.forEach((function(e){e&&e.parentElement&&e.parentElement.removeChild(e)}))}))}p&&p.clear();e.activeWorksheet=t?t.activeWorksheet:null;s.resolve()}),i);return s};FlexGridXlsxConverter._saveContentToWorksheet=function(e,o,t,l,r,n,i,s,a,u,d,c,f,m,h,_,p,x,g){for(var w=this,v=g||(u?20:200),_loop_1=function(C){if(e&&e.cancelled)return{value:void 0};if(o&&C-l>v&&Date.now()-t>100){setTimeout((function(){if(!e||!e.cancelled){p(C);w._saveContentToWorksheet(e,o,Date.now(),C,r,n,i,s,a,u,d,c,f,m,h,_,p,x,g)}}),0);return{value:void 0}}for(;C-r.rowsOffset>=r.panels[r.panelIdx][1].rows.length;){r.rowsOffset+=r.panels[r.panelIdx][1].rows.length;r.panelIdx++}var b=r.panels[r.panelIdx],S=b[0],T=b[1],X=C-r.rowsOffset,j=T.rows[X];if(T.cellType!==wijmo_grid_1.CellType.Cell&&j.renderSize<=0||j instanceof wijmo_grid_1._NewRowTemplate)return"continue";var F=0,k={},R=new mXlsx.WorkbookRow,A=j instanceof wijmo_grid_1.GroupRow,E=0;T.cellType===wijmo_grid_1.CellType.Cell&&(A?E=j.level:n.rows.maxGroupLevel>-1&&(E=n.rows.maxGroupLevel+1));var G=a(T.cellType);s&&(F=y._parseFlexGridRowToSheetRow(i,S,k,X,0,G,u,d,c,f,A,E,m,h,_));y._parseFlexGridRowToSheetRow(i,T,k,X,F,G,u,d,c,f,A,E,m,h,_);if(k.cells.length>0){R._deserialize(k);i._addWorkbookRow(R,r.globRowIdx)}r.globRowIdx++},y=this,C=l;C<r.totalRows;C++){var b=_loop_1(C);if("object"==typeof b)return b.value}wijmo_1.isFunction(x)&&x()};FlexGridXlsxConverter._loadToFlexGrid=function(e,o,t){if(softTransposedMultiRow()&&e instanceof softTransposedMultiRow().TransposedMultiRow)throw"Not supported.";t=t||{};var l,r=null!=e.wj_sheetInfo,n={},i=[],s=[],a={};e.itemsSource=null;e.columns.clear();e.columnHeaders.rows.clear();e.rows.clear();e.columns._frozenInternal=0;e.rows._frozenInternal=0;var u=null==t.sheetIndex||isNaN(t.sheetIndex)?0:t.sheetIndex;if(u<0||u>=o.sheets.length)throw"The sheet index option is out of the sheet range of current workbook.";if(null!=t.sheetName)for(var d=0;d<o.sheets.length;d++)if(t.sheetName===o.sheets[d].name){l=o.sheets[d];break}if(null!=(l=l||o.sheets[u]).rows){for(var c=this._getColumnCount(l.rows),f=this._getRowCount(l.rows,c),m=l.columns,h=0;h<c;h++){e.columns.push(new wijmo_grid_1.Column);if(V=m[h]?m[h]:l._extraColumn){isNaN(+V.width)||(e.columns[h].width=+V.width);V.visible||null==V.visible||(e.columns[h].visible=!!V.visible);V.style&&V.style.wordWrap&&(e.columns[h].wordWrap=V.style.wordWrap)}}var _,p=(null==t.includeColumnHeaders||t.includeColumnHeaders)&&l.rows.length>0,x=!(!t||null==t.includeRowHeaders)&&t.includeRowHeaders,g=p?this._getColumnHeadersHeight(l):0,w=!1,v=[],y=l.frozenPane&&l.frozenPane.rows,C=l.frozenPane&&l.frozenPane.columns;y=wijmo_1.isNumber(y)&&!isNaN(y)?y:null;C=wijmo_1.isNumber(C)&&!isNaN(C)?C:null;for(var b=g;b<f;b++){var S=!1,T=null,X=l.rows[b];if(X)for(var j=b+1;j<l.rows.length;){var F=l.rows[j];if(F){(isNaN(X.groupLevel)&&!isNaN(F.groupLevel)||!isNaN(X.groupLevel)&&X.groupLevel<F.groupLevel)&&(S=!0);break}j++}if(S&&!l.summaryBelow){_&&(_.isCollapsed=w);(_=new wijmo_grid_1.GroupRow).isReadOnly=!1;w=null!=X.collapsed&&X.collapsed;_.level=isNaN(X.groupLevel)?0:X.groupLevel;a[_.level]=w;this._checkParentCollapsed(a,_.level)&&_._setFlag(wijmo_grid_1.RowColFlags.ParentCollapsed,!0);e.rows.push(_)}else{var k=new wijmo_grid_1.Row;X&&this._checkParentCollapsed(a,X.groupLevel)&&k._setFlag(wijmo_grid_1.RowColFlags.ParentCollapsed,!0);e.rows.push(k)}X&&X.height&&!isNaN(X.height)&&(e.rows[b-g].height=X.height);for(h=0;h<c;h++)if(X){var R=X.cells[h],A=R?R.formula:null;A&&"="!==A[0]&&(A="="+A);if(R&&R.textRuns&&R.textRuns.length>0){e.rows[b-g].isContentHtml=!0;e.setCellData(b-g,h,this._parseTextRunsToHTML(R.textRuns))}else{var E=A&&r?A:this._getItemValue(R);e.setCellData(b-g,h,E,""!=E)}S||this._setColumn(v,h,R);var G=b*c+h,W=R?R.style:null;if(W){T=null==T?!!W.wordWrap:T&&!!W.wordWrap;if(r){var M=mXlsx.Workbook._parseExcelFormat(R),H=void 0;if(W.hAlign)H=mXlsx.Workbook._parseHAlignToString(wijmo_1.asEnum(W.hAlign,mXlsx.HAlign));else switch(this._getItemType(R)){case wijmo_1.DataType.Number:H="right";break;case wijmo_1.DataType.Boolean:H="center";break;default:H=M&&0===M.search(/[n,c,p]/i)?"right":"left"}n[G]={fontWeight:W.font&&W.font.bold?"bold":"none",fontStyle:W.font&&W.font.italic?"italic":"none",textDecoration:W.font&&W.font.underline?"underline":"none",textAlign:H,fontFamily:W.font&&W.font.family?W.font.family:"",fontSize:W.font&&W.font.size?W.font.size+"px":"",color:W.font&&W.font.color?W.font.color:"",backgroundColor:W.fill&&W.fill.color?W.fill.color:"",whiteSpace:W.wordWrap?"pre-wrap":"normal",format:M};if(W.borders){if(W.borders.left){this._parseBorderStyle(W.borders.left.style,"Left",n[G]);n[G].borderLeftColor=W.borders.left.color}if(W.borders.right){this._parseBorderStyle(W.borders.right.style,"Right",n[G]);n[G].borderRightColor=W.borders.right.color}if(W.borders.top){this._parseBorderStyle(W.borders.top.style,"Top",n[G]);n[G].borderTopColor=W.borders.top.color}if(W.borders.bottom){this._parseBorderStyle(W.borders.bottom.style,"Bottom",n[G]);n[G].borderBottomColor=W.borders.bottom.color}}if(W.fill&&W.fill.color){var I=n[G],B=W.borders,D=W.fill.color;if(B){B.left&&B.left.color||(I.borderLeftColor=D);B.right&&B.right.color||h===C-1||(I.borderRightColor=D);B.top&&B.top.color||(I.borderTopColor=D);B.bottom&&B.bottom.color||b===y-1||(I.borderBottomColor=D)}else{I.borderLeftColor=D;h!==C-1&&(I.borderRightColor=D);I.borderTopColor=D;b!==y-1&&(I.borderBottomColor=D)}}W.font&&-1===s.indexOf(W.font.family)&&s.push(W.font.family)}}r&&R&&wijmo_1.isNumber(R.rowSpan)&&R.rowSpan>0&&wijmo_1.isNumber(R.colSpan)&&R.colSpan>0&&(R.rowSpan>1||R.colSpan>1)&&i.push(new wijmo_grid_1.CellRange(b,h,b+R.rowSpan-1,h+R.colSpan-1))}if(X){this._checkParentCollapsed(a,X.groupLevel)||X.visible||null==X.visible||(e.rows[b-g].visible=X.visible);e.rows[b-g].wordWrap=!!X.style&&!!X.style.wordWrap||!!T}}_&&(_.isCollapsed=w);null!=C&&(e.columns._frozenInternal=x&&C>0?C-1:C);null!=y&&(e.rows._frozenInternal=p&&y>0?y-1:y);for(h=0;h<e.columnHeaders.columns.length;h++){var N=v[h],O=e.columns[h];O.isRequired=!1;if(N){N.dataType===wijmo_1.DataType.Boolean&&(O.dataType=N.dataType);O.format=N.format;O.align=N.hAlign;O.wordWrap=O.wordWrap||!!N.wordWrap}}for(d=0;d<Math.max(g,1);d++)e.columnHeaders.rows.push(new wijmo_grid_1.Row);for(d=0;d<g;d++)for(var z=0;z<e.columnHeaders.columns.length;z++){var L=l.rows[d]?l.rows[d].cells[z]:null,P=L&&null!=L.value?L.value:"",V=e.columnHeaders.columns[z];if(P){var U=mXlsx.Workbook._parseExcelFormat(L);P=wijmo_1.Globalize.format(P,U)}V.header=V.header||P;e.columnHeaders.setCellData(d,z,P)}if(r){var q=null!=t.sheetVisible?t.sheetVisible:!1!==l.visible;e.wj_sheetInfo.name=l.name;e.wj_sheetInfo.visible=q;e.wj_sheetInfo.styledCells=n;e.wj_sheetInfo.mergedRanges=i;e.wj_sheetInfo.fonts=s;e.wj_sheetInfo.tables=l.tables}}};FlexGridXlsxConverter._getColumnHeadersHeight=function(e){var o;if(!e||!(o=e.rows).length)return 0;if(!o[0])return 1;for(var t=0,l=1;t<o.length&&l>0;t++,l--){var r=o[t].cells.reduce((function(e,o){return Math.max(e,o.rowSpan||0)}),1);r>l&&(l=r)}return t};FlexGridXlsxConverter._escapePlainText=function(e){return null==e?"":""===e?"'":"'"===e[0]||e.length>1&&"="===e[0]&&"="===e[1]?"'"+e:e};FlexGridXlsxConverter._parseFlexGridRowToSheetRow=function(e,o,t,l,r,n,i,s,a,u,d,c,f,m,h){var _=o.grid,p=_.wj_sheetInfo,x=o.rows[l],g=0,w=p&&p.evaluateFormula;null==x.recordIndex?o.cellType===wijmo_grid_1.CellType.ColumnHeader&&o.rows.length>1&&(g=Math.min(l,n.length-1)):g=x.recordIndex;t.cells||(t.cells=[]);t.visible=x.isVisible;t.height=t.visible?x.renderHeight||o.rows.defaultSize:x.height;t.groupLevel=c;var v=null;if(d){t.collapsed=x.isCollapsed;v=x instanceof wijmo_grid_1.GroupRow?x:null}var y=v&&(_.groupSummaryPosition===wijmo_grid_1.GroupSummaryPosition.Bottom||_.groupSummaryPosition===wijmo_grid_1.GroupSummaryPosition.Auto&&!v.isCollapsed),C=v&&!v.isSummary&&y;x.wordWrap&&(t.style={wordWrap:x.wordWrap});for(var b,S=x.constructor===wijmo_grid_1.Row||x.constructor===wijmo_grid_1._NewRowTemplate||softTransposed()&&_ instanceof softTransposed().TransposedGrid&&x instanceof wijmo_grid_1.Row||softDetail()&&x.constructor===softDetail().DetailRow||softMultiRow()&&x.constructor===softMultiRow()._MultiRow||softTransposedMultiRow()&&x instanceof softTransposedMultiRow()._MultiRow,T=softDetail()&&x.constructor===softDetail().DetailRow,X=0,j=Math.round(mXlsx._xlsx._parsePixelToCharWidth(_.treeIndent)||0),getTreeIndent=function(e){return e*j},F=!1;X<o.columns.length;X++){var k=void 0,R=void 0,A=void 0,E=1,G=1,W=!1,M=_._getBindingColumn(o,l,o.columns[X]),H=0;if(p&&o===_.cells){var I=l*o.columns.length+X;p.mergedRanges&&(k=this._getMergedRange(l,X,p.mergedRanges));p.styledCells&&(R=p.styledCells[I])}else if(i!==_ExportCellStyles.None){A=this._getMeasureCell(o,X,s,a);R=(k=_.getMergedRangeRawData(o,l,X,!1))?this._getCellStyle(o,A,k.bottomRow,k.rightCol,u,!!h)||{}:this._getCellStyle(o,A,l,X,u,!!h)||{}}k||(k=_.getMergedRangeRawData(o,l,X,!1));if(k){if(l===k.topRow&&X===k.leftCol){G=k.bottomRow-k.topRow+1;E=this._getColSpan(o,k,f);W=!0}if(X>k.leftCol&&X<=k.rightCol&&F){W=!0;F=!1;E=k.rightCol-X+1}}else W=!0;if(!f||f(M)){var B=n[g]?n[g][X+r]:null,D=void 0,N=void 0,O=void 0,z=void 0,L=void 0,P=void 0,V=void 0;if(S||d){O=W?o.getCellData(l,X,!0):null;z=W?o.getCellData(l,X,!1):null;N=this._isFormula(O);D=null;L=wijmo_1.isDate(z);if(o.cellType===wijmo_grid_1.CellType.ColumnHeader&&wijmo_1.isString(O))V="General";else if(R&&R.format){P=R.format;/[hsmyt\:]/i.test(P={d:"M/d/yyyy",D:"dddd, MMMM dd, yyyy"}[P]||P)&&(L=!0);V=mXlsx.Workbook._parseCellFormat(R.format,L)}else if(B&&B.style&&B.style.format){P=M.format;V=B.style.format}else V=null;N&&null!=w&&wijmo_1.isFunction(w)&&(D=w(O));if(!V)if(L)V="m/d/yyyy";else if(wijmo_1.isNumber(z)&&!M.dataMap)V=wijmo_1.isInt(z)?"#,##0":"#,##0.00";else if(N){var U=O.toLowerCase();if(U.indexOf("now()")>-1){V="m/d/yyyy h:mm";L=!0}else if(U.indexOf("today()")>-1||U.indexOf("date(")>-1){V="m/d/yyyy";L=!0}else if(U.indexOf("time(")>-1){V="h:mm AM/PM";L=!0}}else V="General"}else{O=W?_.columnHeaders.getCellData(0,X,!0):null;V="General"}var q=void 0;if(wijmo_1.isString(O)&&"{"!==O[0]&&-1!==O.indexOf("<span")){q=this._parseToTextRuns(O);O=null}var Y=this._parseCellStyle(R)||{};if(o===_.cells&&d&&x.hasChildren&&X===_.columns.firstVisibleIndex){var J=void 0;if(N&&null!=D)J=D;else{O?J=O:W&&(J=x.getGroupHeader());J&&(J=J.replace(/<\/?\w+>/g,"").replace(/&#39;/g,"'"))}if(null==J&&!R)continue;!(L=wijmo_1.isDate(J))&&P&&"d"===P.toLowerCase()&&wijmo_1.isInt(J)&&(V="0");J=wijmo_1.isString(J)?mXlsx.Workbook._unescapeXML(J):J;X===_.columns.firstVisibleIndex&&_.treeIndent&&(H=getTreeIndent(c));b={value:J,isDate:L,formula:N?this._parseToExcelFormula(O,L):null,colSpan:E,rowSpan:G,style:this._extend(Y,{format:V,font:_.childItemsPath?{}:{bold:!0},hAlign:e.rightToLeft?mXlsx.HAlign.Right:mXlsx.HAlign.Left,indent:H}),textRuns:q}}else{if(C){O=null;z=null}if(d||m===HtmlEntityConversion.Auto&&M.isContentHtml||m===HtmlEntityConversion.Yes){O=wijmo_1.isString(O)?mXlsx.Workbook._unescapeXML(O):O;z=wijmo_1.isString(z)?mXlsx.Workbook._unescapeXML(z):z}!L&&P&&"d"===P.toLowerCase()&&wijmo_1.isInt(z)&&(V="0");var K=void 0,$=void 0;K=Y&&Y.hAlign?Y.hAlign:B&&B.style&&null!=B.style.hAlign?wijmo_1.asEnum(B.style.hAlign,mXlsx.HAlign,!0):wijmo_1.isDate(z)?mXlsx.HAlign.Left:mXlsx.HAlign.General;o===_.cells&&X===_.columns.firstVisibleIndex&&_.treeIndent&&(e.rightToLeft&&K===mXlsx.HAlign.Right||!e.rightToLeft&&K===mXlsx.HAlign.Left||K===mXlsx.HAlign.General)&&(H=getTreeIndent(c));R&&R.verticalAlign&&($=mXlsx.Workbook._parseStringToVAlign(R.verticalAlign));b={value:N?D:"General"!==V||""===O&&null==z||!0===z||!1===z?this._escapePlainText(z):this._escapePlainText(O),isDate:L,formula:N?this._parseToExcelFormula(O,L):null,colSpan:X<_.columns.firstVisibleIndex?1:E,rowSpan:G,style:this._extend(Y,{format:V,hAlign:K,vAlign:void 0!==$?$:G>1?o===_.cells||!1===_.centerHeadersVertically?mXlsx.VAlign.Top:mXlsx.VAlign.Center:null,indent:H}),textRuns:q}}if(h){h(new XlsxFormatItemEventArgs(o,new wijmo_grid_1.CellRange(l,X),A,s,a,u,b))}if(T){var Q=o.getCellElement(l,X);if(Q){var Z=x.detail;Q.appendChild(Z);wijmo_1.Control.refreshAll(Z)}}t.cells.push(b)}else F=W}return r+X};FlexGridXlsxConverter._parseCellStyle=function(e,o){void 0===o&&(o=!1);if(null==e)return null;var t=e.fontSize;t=t?+t.substring(0,t.indexOf("px")):null;isNaN(t)&&(t=null);var l=e.whiteSpace;l=!!l&&l.indexOf("pre")>-1;var r=e.textAlign;"start"===r&&(r="rtl"===e.direction?"right":"left");"end"===r&&(r="rtl"===e.direction?"left":"right");return{font:{bold:"bold"===e.fontWeight||+e.fontWeight>=700,italic:"italic"===e.fontStyle,underline:"underline"===(e.textDecorationStyle||e.textDecoration),family:this._parseToExcelFontFamily(e.fontFamily),size:t,color:e.color},fill:{color:e.backgroundColor},borders:this._parseBorder(e,o),hAlign:mXlsx.Workbook._parseStringToHAlign(r),wordWrap:l}};FlexGridXlsxConverter._parseBorder=function(e,o){var t={left:this._parseEgdeBorder(e,"Left"),right:this._parseEgdeBorder(e,"Right"),top:this._parseEgdeBorder(e,"Top"),bottom:this._parseEgdeBorder(e,"Bottom")};if(o){t.vertical=this._parseEgdeBorder(e,"Vertical");t.horizontal=this._parseEgdeBorder(e,"Horizontal")}return t};FlexGridXlsxConverter._parseEgdeBorder=function(e,o){var t,l=e["border"+o+"Style"],r=e["border"+o+"Width"];r&&(r=parseFloat(r));if(l&&"none"!==l&&"hidden"!==l&&0!==r){t={};switch(l=l.toLowerCase()){case"dotted":t.style=r>1?mXlsx.BorderStyle.MediumDashDotted:mXlsx.BorderStyle.Dotted;break;case"dashed":t.style=r>1?mXlsx.BorderStyle.MediumDashed:mXlsx.BorderStyle.Dashed;break;case"double":t.style=mXlsx.BorderStyle.Double;break;default:t.style=r>2?mXlsx.BorderStyle.Thick:r>1?mXlsx.BorderStyle.Medium:mXlsx.BorderStyle.Thin}t.color=e["border"+o+"Color"]}return t};FlexGridXlsxConverter._parseBorderStyle=function(e,o,t){var l="border"+o+"Style",r="border"+o+"Width";switch(e){case mXlsx.BorderStyle.Dotted:case mXlsx.BorderStyle.Hair:t[l]="dotted";t[r]="1px";break;case mXlsx.BorderStyle.Dashed:case mXlsx.BorderStyle.ThinDashDotDotted:case mXlsx.BorderStyle.ThinDashDotted:t[l]="dashed";t[r]="1px";break;case mXlsx.BorderStyle.MediumDashed:case mXlsx.BorderStyle.MediumDashDotDotted:case mXlsx.BorderStyle.MediumDashDotted:case mXlsx.BorderStyle.SlantedMediumDashDotted:t[l]="dashed";t[r]="2px";break;case mXlsx.BorderStyle.Double:t[l]="double";t[r]="3px";break;case mXlsx.BorderStyle.Medium:t[l]="solid";t[r]="2px";break;case mXlsx.BorderStyle.Thick:t[l]="solid";t[r]="3px";break;default:t[l]="solid";t[r]="1px"}};FlexGridXlsxConverter._parseToExcelFontFamily=function(e){var o;e&&(o=e.split(","))&&o.length>0&&(e=o[0].replace(/\"|\'/g,""));return e};FlexGridXlsxConverter._parseToExcelFormula=function(e,o){var t=e.match(/(floor|ceiling)\([+-]?\d+\.?\d*\)/gi);if(t)for(var l=0;l<t.length;l++){var r=(i=t[l]).substring(0,i.lastIndexOf(")"))+", 1)";e=e.replace(i,r)}t=null;if(t=e.match(/text\(\"?\w+\"?\s*\,\s*\"\w+\"\)/gi)){var n=/\"?\w+\"?\s*\,\s*\"(\w+)\"/i;for(l=0;l<t.length;l++){var i,s=(i=t[l]).match(n);if(s&&2===s.length){var a=s[1];if(!/^d{1,4}?$/.test(a)){var u=mXlsx.Workbook._parseCellFormat(a,o);r=i.replace(a,u);e=e.replace(i,r)}}}}return e};FlexGridXlsxConverter._parseToTextRuns=function(e){for(var o=e.split("<span "),t=[],l=0;l<o.length;l++){var r=o[l],n=void 0;if(-1!==r.indexOf("</span>")){n={text:r.substring(r.indexOf(">")+1,r.indexOf("</span>")),font:this._parseToTextRunFont(r.substring(r.indexOf('style="')+7,r.indexOf(';"')))}}else n={text:r};t.push(n)}return t};FlexGridXlsxConverter._parseToTextRunFont=function(e){var o,t=e.split(";");if(t.length>0){for(var l=void 0,r=void 0,n=void 0,i=void 0,s=void 0,a=void 0,u=0;u<t.length;u++){var d=t[u].split(":");if(2===d.length){d[1]=d[1].trim();switch(d[0]){case"font-size":i=+d[1].substring(0,d[1].indexOf("px"));isNaN(i)&&(i=null);break;case"font-weight":l="bold"===d[1]||+d[1]>=700;break;case"font-style":r="italic"===d[1];break;case"text-decoration-style":case"text-decoration":n="underline"===d[1];break;case"font-family":s=this._parseToExcelFontFamily(d[1]);break;case"color":a=d[1]}}}o={bold:l,italic:r,underline:n,family:s,size:i,color:a}}return o};FlexGridXlsxConverter._getMeasureCell=function(e,o,t,l){var r=l[e.cellType],n=r&&r[o],i=null==n;if(n){if(this.hasCssText){n.style.cssText="";n.style.visibility="hidden"}}else{r||(l[e.cellType]=r=[]);r[o]=n=t.cloneNode()}!i&&n.parentElement||(e.hostElement.children.length>0?e.hostElement.children[0].appendChild(n):e.hostElement.appendChild(n));return n};FlexGridXlsxConverter._getColumnSetting=function(e,o,t){var l=e;null!=e.colspan&&(l=this._getRenderColumn(o,t));return l?{autoWidth:!0,width:l.visible?l.renderWidth||t.defaultSize:l.width,visible:l.visible&&0!==l.width&&!l._getFlag(wijmo_grid_1.RowColFlags.ParentCollapsed),style:{format:e.format?mXlsx.Workbook._parseCellFormat(e.format,e.dataType===wijmo_1.DataType.Date):"",hAlign:mXlsx.Workbook._parseStringToHAlign(this._toExcelHAlign(l.getAlignment())),wordWrap:l.wordWrap}}:null};FlexGridXlsxConverter._getPerRowColumnsSettings=function(e,o,t){var l=this,r=[],n=[];o.forEach((function(i,s){for(var a=0,u=s>0?o[0].columns.length:0,_loop_2=function(o){if(null!=t&&o>=t)return"break";if(i.rows[o].renderSize<=0)return"continue";r[a]=r[a]||[];n[a]=n[a]||[];i.columns.forEach((function(t,s){var d=e._getBindingColumn(i,o,t),c=l._getColumnSetting(d,s,i.columns);if(c){r[a][u+s]=c;n[a][u+s]=d}}));a++},d=0;d<i.rows.length;d++){if("break"===_loop_2(d))break}}));return{cols:r,bndCols:n}};FlexGridXlsxConverter._toExcelHAlign=function(e){return(e=e?e.trim().toLowerCase():e)?e.indexOf("center")>-1?"center":e.indexOf("right")>-1||e.indexOf("end")>-1?"right":e.indexOf("justify")>-1?"justify":"left":e};FlexGridXlsxConverter._getColumnCount=function(e){for(var o=0,t=[],l=0;l<e.length;l++){var r=e[l]&&e[l].cells?e[l].cells:[];if(r&&r.length>0){var n=r.length;wijmo_1.isInt(r[n-1].colSpan)&&r[n-1].colSpan>1&&(n=n+r[n-1].colSpan-1);if(r[n-1]&&r[n-1].formula){var i=r[n-1].formula.match(wijmo_1.cellCoordinateParserRegex);if(i)for(var s=0,a=i;s<a.length;s++){var u=a[s];t.push(mXlsx.Workbook.tableAddress(u))}}n>o&&(o=n)}}return o};FlexGridXlsxConverter._getRowCount=function(e,o){for(var t=e.length,l=t-1,r=0;r<o;r++)e:for(;l>=0;l--){var n=e[l],i=(n&&n.cells?n.cells:[])[r];if(i&&(null!=i.value&&""!==i.value||wijmo_1.isInt(i.rowSpan)&&i.rowSpan>1)){wijmo_1.isInt(i.rowSpan)&&i.rowSpan>1&&l+i.rowSpan>t&&(t=l+i.rowSpan);break e}}return t};FlexGridXlsxConverter._numAlpha=function(e){var o=Math.floor(e/26)-1;return(o>-1?this._numAlpha(o):"")+String.fromCharCode(65+e%26)};FlexGridXlsxConverter._getItemType=function(e){return null==e||null==e.value||isNaN(e.value)?null:wijmo_1.getType(e.value)};FlexGridXlsxConverter._setColumn=function(e,o,t){var l=e[o],r=this._getItemType(t);r===wijmo_1.DataType.Boolean&&t.formula&&(r=null);if(l){l.dataType!==r&&l.dataType===wijmo_1.DataType.Boolean&&r!==wijmo_1.DataType.Boolean&&(l.dataType=r);if(t&&null!=t.value&&(!wijmo_1.isString(t.value)||!wijmo_1.isNullOrWhiteSpace(t.value))){var n=mXlsx.Workbook._parseExcelFormat(t);n&&l.format!==n&&"General"!==n&&(l.format=n)}var i=void 0,s=void 0;if(t&&t.style){t.style.hAlign&&(i=mXlsx.Workbook._parseHAlignToString(wijmo_1.asEnum(t.style.hAlign,mXlsx.HAlign)));t.style.vAlign&&(s=mXlsx.Workbook._parseVAlignToString(wijmo_1.asEnum(t.style.vAlign,mXlsx.VAlign)));null==l.wordWrap?l.wordWrap=!!t.style.wordWrap:l.wordWrap=l.wordWrap&&!!t.style.wordWrap}i||r!==wijmo_1.DataType.Number||(i="right");l.hAlign=i;l.vAlign=s}else e[o]={dataType:r,format:mXlsx.Workbook._parseExcelFormat(t),hAlign:"",vAlign:"",wordWrap:null}};FlexGridXlsxConverter._getItemValue=function(e){if(null==e||null==e.value)return null;var o=e.value;wijmo_1.isString(o)&&"'"===o[0]&&(o=o.substr(1));return wijmo_1.isNumber(o)&&isNaN(o)?"":o instanceof Date&&isNaN(o.getTime())?"":o};FlexGridXlsxConverter._getCellStyle=function(e,o,t,l,r,n){var i,s=e.grid;try{var a=!(r&&!s.formatItem.hasHandlers&&!s.itemFormatter&&!n);s.cellFactory.updateCell(e,t,l,o,null,a);o.className=o.className.replace("wj-state-selected","");o.className=o.className.replace("wj-state-multi-selected","")}catch(e){return null}if(r){var u=e.hostElement,d=o,c=d.style.cssText.split(/;\s+/).filter((function(e){var o=e.substring(0,e.indexOf(":"));return/^(color|background|border|font|text|whitespace)/i.test(o)})).join(";");do{c=d.className+c}while(d!==u&&(d=d.parentElement));if(!(i=r.getValue(c))){i=window.getComputedStyle(o);r.add(c,i)}}else i=window.getComputedStyle(o);return i};FlexGridXlsxConverter._parseTextRunsToHTML=function(e){for(var o="",t=0;t<e.length;t++){var l=e[t],r=l.font;o+=r?'<span style="'+(r.bold?"font-weight: bold;":"")+(r.italic?"font-style: italic;":"")+(r.underline?"text-decoration: underline;":"")+(r.family?"font-family: "+r.family+";":"")+(null!=r.size?"font-size: "+r.size+"px;":"")+(r.color?"color: "+r.color+";":"")+'">'+l.text+"</span>":l.text}return o};FlexGridXlsxConverter._extend=function(e,o){for(var t in o){var l=o[t];wijmo_1.isObject(l)&&e[t]?wijmo_1.copy(e[t],l):e[t]=l}return e};FlexGridXlsxConverter._checkParentCollapsed=function(e,o){var t=!1;Object.keys(e).forEach((function(l){!0===e[l]&&!1===t&&!isNaN(o)&&+l<o&&(t=!0)}));return t};FlexGridXlsxConverter._getColSpan=function(e,o,t){for(var l=0,r=o.leftCol;r<=o.rightCol;r++)t&&!t(e.columns[r])||l++;return l};FlexGridXlsxConverter._getRenderColumn=function(e,o){return e>=o.length?null:o[e]};FlexGridXlsxConverter._getMergedRange=function(e,o,t){for(var l=0;l<t.length;l++){var r=t[l];if(e>=r.topRow&&e<=r.bottomRow&&o>=r.leftCol&&o<=r.rightCol)return r}return null};FlexGridXlsxConverter._isFormula=function(e){return e&&"string"==typeof e&&e.length>1&&"="===e[0]&&"="!==e[1]};FlexGridXlsxConverter._stopExportsOnGridChange=!0;return FlexGridXlsxConverter}();exports.FlexGridXlsxConverter=FlexGridXlsxConverter;var _ExportCellStyles,XlsxFormatItemEventArgs=function(e){__extends(XlsxFormatItemEventArgs,e);function XlsxFormatItemEventArgs(o,t,l,r,n,i,s){var a=e.call(this,o,t)||this;a._cell=l;a._patternCell=r;a._xlsxCell=s;a._cellsCache=n;a._styleCache=i;return a}Object.defineProperty(XlsxFormatItemEventArgs.prototype,"cell",{get:function(){return this._cell},enumerable:!0,configurable:!0});Object.defineProperty(XlsxFormatItemEventArgs.prototype,"xlsxCell",{get:function(){return this._xlsxCell},set:function(e){this._xlsxCell=e},enumerable:!0,configurable:!0});XlsxFormatItemEventArgs.prototype.getFormattedCell=function(){if(!this._cell){this._cell=FlexGridXlsxConverter._getMeasureCell(this.panel,this.col,this._patternCell,this._cellsCache);FlexGridXlsxConverter._getCellStyle(this.panel,this._cell,this.row,this.col,this._styleCache,!0)}return this._cell};return XlsxFormatItemEventArgs}(wijmo_grid_1.CellRangeEventArgs);exports.XlsxFormatItemEventArgs=XlsxFormatItemEventArgs;!function(e){e[e.None=0]="None";e[e.Regular=1]="Regular";e[e.Cache=2]="Cache"}(_ExportCellStyles||(_ExportCellStyles={}));var HtmlEntityConversion,_StyleCache=function(){function _StyleCache(e){this._cache={};this._size=0;this._max=e}_StyleCache.prototype.add=function(e,o){this._size>=this._max&&this.clear();this._cache[e]=this._cloneStyle(o);this._size++};_StyleCache.prototype.clear=function(){this._cache={};this._size=0};_StyleCache.prototype.getValue=function(e){return this._cache[e]||null};_StyleCache.prototype.hasKey=function(e){return!!this._cache[e]};_StyleCache.prototype._cloneStyle=function(e){if(!e)return null;for(var o={},toCamel=function(e){return e.replace(/\-([a-z])/g,(function(e,o,t){return t>0?o.toUpperCase():o}))},t=0,l=e.length;t<l;t++){var r=e[t];o[toCamel(r)]=e.getPropertyValue(r)}return o};return _StyleCache}();exports._StyleCache=_StyleCache;function _blobToBuffer(e,o){if(e&&o)if(e.arrayBuffer)e.arrayBuffer().then((function(e){return o(e)}));else{var t=new FileReader;t.onload=function(){o(t.result);t=null};t.readAsArrayBuffer(e)}}exports._blobToBuffer=_blobToBuffer;!function(e){e[e.Auto=0]="Auto";e[e.No=1]="No";e[e.Yes=2]="Yes"}(HtmlEntityConversion=exports.HtmlEntityConversion||(exports.HtmlEntityConversion={}));wijmo_1._registerModule("wijmo.grid.xlsx",selfModule);