/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

import{forwardRef}from"react";import{ControlBaseMeta,baseFlushSync,selectiveDomRender,selectiveDomUnmount,useWjComponentBase,useWjComponentChildBase}from"@mescius/wijmo.react.base";import{asBoolean,asEnum,asFunction}from"@mescius/wijmo";import*as React from"react";import*as wjcGrid from"@mescius/wijmo.grid";import*as wjcInteropGrid from"@mescius/wijmo.interop.grid";export var CellTemplateType=wjcInteropGrid.GridCellTemplateType;export const FlexGridMeta={inputs:[...ControlBaseMeta.inputs,"allowAddNew","allowDelete","allowDragging","allowMerging","allowPinning","allowResizing","allowSorting","alternatingRowStep","anchorCursor","ariaLabel","autoClipboard","autoGenerateColumns","autoRowHeights","autoScroll","autoSearch","autoSizeMode","bigCheckboxes","caseSensitiveSearch","cellFactory","childItemsPath","cloneFrozenCells","columns","columnGroups","columnLayout","commitEmptyEdits","copyHeaders","deferResizing","editColumnIndex","errorTip","expandSelectionOnCopyPaste","frozenCells","frozenColumns","frozenRows","groupHeaderFormat","groupSummaryPosition","headersFocusability","headersVisibility","imeEnabled","isReadOnly","itemFormatter","itemValidator","itemsSource","keyActionEnter","keyActionTab","lazyRender","maxContent","mergeManager","newRowAtTop","pasteEmptyCells","preserveOutlineState","preserveSelectedState","preserveWhiteSpace","quickAutoSize","refreshOnEdit","rowHeaderPath","scrollPosition","scrollSize","selectedItems","selectedRanges","selectedRows","selection","selectionMode","showDropDown","showErrors","showGroups","showMarquee","showPlaceholders","showSelectedHeaders","showSort","skipMerged","sortRowIndex","stickyHeaders","treeIndent","validateEdits","virtualizationThreshold"],events:[...ControlBaseMeta.events,"autoSizedColumn","autoSizedRow","autoSizingColumn","autoSizingRow","beginningEdit","cellEditEnded","cellEditEnding","columnGroupCollapsedChanged","columnGroupCollapsedChanging","copied","copying","deletedRow","deletingRow","draggedColumn","draggedRow","draggingColumn","draggingColumnOver","draggingRow","draggingRowOver","formatItem","groupCollapsedChanged","groupCollapsedChanging","itemsSourceChanged","itemsSourceChanging","loadedRows","loadingRows","pasted","pastedCell","pasting","pastingCell","pinnedColumn","pinningColumn","prepareCellForEdit","resizedColumn","resizedRow","resizingColumn","resizingRow","rowAdded","rowEditEnded","rowEditEnding","rowEditStarted","rowEditStarting","scrollPositionChanged","selectionChanged","selectionChanging","sortedColumn","sortingColumn","starSizedColumns","updatedLayout","updatedView","updatingLayout","updatingView"]};export const FlexGrid=forwardRef((function(e,t){return useWjComponentBase({ref:t,properties:FlexGridMeta.inputs,events:FlexGridMeta.events,props:e,constructor:wjcGrid.FlexGrid,initControl:e=>{e.cellFactory=new DirectiveCellFactory(e)}}).renderResult}));export const RowColMeta={inputs:["align","allowDragging","allowMerging","allowResizing","binding","cssClass","cssClassAll","dataMap","dataMapEditor","dataType","dropDownCssClass","format","inputType","isContentHtml","isReadOnly","isRequired","isSelected","isVisible","mask","maxLength","multiLine","size","sortMemberPath","visible","wordWrap"],events:["gridChanged"]};export const FlexGridColumnMeta={inputs:[...RowColMeta.inputs,"aggregate","allowSorting","cellTemplate","describedById","editor","header","maxWidth","minWidth","name","quickAutoSize","width"],events:[...RowColMeta.events]};export const FlexGridColumn=forwardRef((function(e,t){const r=useWjComponentChildBase({ref:t,properties:FlexGridColumnMeta.inputs,events:FlexGridColumnMeta.events,props:e,constructor:wjcGrid.Column,customConstructor:(e,t)=>{e.autoGenerateColumns=!1;return new wjcGrid.Column(t)},needParentInstance:!1,parentProp:"columns",isParentPropArray:!0,assignedToParent:!0});return Object.assign({$_wjComponent:!0},r)}));export const FlexGridColumnGroupMeta={inputs:[...FlexGridColumnMeta.inputs,"collapseTo","columns","height","isCollapsed"],events:[...FlexGridColumnMeta.events]};export const FlexGridColumnGroup=forwardRef((function(e,t){const r=useWjComponentChildBase({ref:t,properties:FlexGridColumnGroupMeta.inputs,events:FlexGridColumnGroupMeta.events,props:e,constructor:wjcGrid.ColumnGroup,customConstructor:(e,t)=>{e.autoGenerateColumns=!1;return new wjcGrid.ColumnGroup(t)},needParentInstance:!1,parentProp:"columnGroups",isParentPropArray:!0,assignedToParent:!0});return Object.assign({$_wjComponent:!0},r)}));export const FlexGridCellTemplateMeta={inputs:["cellType","template","autoSizeRows"],events:[]};export const FlexGridCellTemplate=forwardRef((function(e,t){const r=useWjComponentChildBase({ref:t,properties:FlexGridCellTemplateMeta.inputs,events:FlexGridCellTemplateMeta.events,props:e,constructor:ReactFlexGridCellTemplate,needParentInstance:!0,parentProp:"",isParentPropArray:!1,assignedToParent:!1});return Object.assign({$_wjComponent:!0},r)}));export class ReactFlexGridCellTemplate{constructor(e,t){this.autoSizeRows=!0;this.parent=e;this.cellType=asEnum(t.cellType,wjcInteropGrid.GridCellTemplateType,!1);const r=wjcInteropGrid.DirectiveCellFactoryBase.getTemplContextProp(this.cellType);this.template=asFunction(t.template,!0);e[r]=this}initialize(e){this.removeBinding();this.cellType=asEnum(null==e.cellType?this.cellType:e.cellType,wjcInteropGrid.GridCellTemplateType,!1);this.template=void 0===e.template?this.template:asFunction(e.template,!0);const t=wjcInteropGrid.DirectiveCellFactoryBase.getTemplContextProp(this.cellType);this.parent[t]=this;this.autoSizeRows=void 0===e.autoSizeRows?this.autoSizeRows:asBoolean(e.autoSizeRows,!0)||!1;void 0!==e.template&&this.parent&&(this.parent.grid?this.parent.grid.invalidate():this.parent.invalidate&&this.parent.invalidate());this.parent&&this.parent instanceof wjcGrid.Column&&this.parent._setFlag(wjcGrid.RowColFlags.HasTemplate,!0,!0)}removeBinding(){const e=wjcInteropGrid.DirectiveCellFactoryBase.getTemplContextProp(this.cellType);delete this.parent[e];this.parent&&this.parent instanceof wjcGrid.Column&&this.parent._setFlag(wjcGrid.RowColFlags.HasTemplate,!1,!0)}dispose(){this.removeBinding();this.parent&&this.parent.grid?this.parent.grid.invalidate():this.parent&&this.parent.invalidate&&this.parent.invalidate()}}export class DirectiveCellFactory extends wjcInteropGrid.DirectiveCellFactoryBase{constructor(e){super(e);this._renderedCells=[];e.updatedView.addHandler(e=>{queueMicrotask(()=>this._reRenderCells())},this)}shouldInstantiate(e){const t=e.templateCache;return null==t||t.column!==e.column||t.templateContextProperty!==e.templateContextProperty||e.cell.firstChild!=t.rootElement}renderTemplate(e,t){let r=e.row,i=e.templateContext,n=e.cell;e.cellBindingsData=this.setBindingsData({},r,e.column,r.dataItem,e.cellValue,i.valuePaths);e.cellBindingsData.localVars.valueFormatted=e.cellValueFormatted;this._renderCell(n,e);if(t){this._addRenderedCell(n);let t=e.templateCache={column:e.column,rootElement:n.firstElementChild,templateContextProperty:e.templateContextProperty};n[e.templateContextProperty]=t}}flushPendingUpdates(){baseFlushSync()}applyImmediately(e){}flushPendingEvents(e){}getEditorFocusFlag(){return!0}setEditorFocusFlag(e){}disposeTemplate(e,t,r){if(t){selectiveDomUnmount(e);this._removeRenderedCell(e);super.disposeTemplate(e,t,r)}}clearCell(e){selectiveDomUnmount(e)}canRender(e){return!(!e||!e.template)}_renderCell(e,t){var r=t||e.__wjCellLastRenderedProp;if(r){let t=r&&r.templateContext.template,i=r.cellBindingsData.localVars;i.row&&!i.row.grid&&(i.row=r.panel.grid.rows[i.row.index]);if(!i.row)return;selectiveDomRender(React.createElement("div",{},t&&t(i)),e);e.__wjCellLastRenderedProp=r}}_addRenderedCell(e){let t=this._renderedCells;t.indexOf(e)<0&&t.push(e)}_removeRenderedCell(e){let t=this._renderedCells,r=t.indexOf(e);r>-1&&t.splice(r,1)}_reRenderCells(){this._renderedCells.forEach(e=>this._renderCell(e))}checkHeight(e){"$__cellTemplGroupHeader"!==e.templateContextProperty&&(this._isCheckingHeight||setTimeout(()=>{if(this._isCheckingHeight)return;var t=e.panel.rows,r=e.row.index;if(!t[r])return;let i=e.cell;const n=i.style.height;i.style.height="0";let o=i.scrollHeight>7?i.scrollHeight:t[r].renderHeight;i.style.height=n;if(e.cellStamp===i[wjcInteropGrid.DirectiveCellFactoryBase._cellStampProp]){var l=e.rng,s=l&&l.rowSpan||1,a=e.isEdit;null!=t.maxSize&&(o=Math.min(o,t.maxSize));if(r<t.length&&t[r].renderHeight<o-1||t[r].renderHeight>o+1&&!a&&e.panel.cellType===wjcGrid.CellType.Cell&&1===s){const t=o/s;!e.row.resizedManually&&(null==e.row.height||e.row.height<t)&&(e.row.height=t);if(a){let r=this._isFullEdit(),i=this.grid;this._backupHeight=e.row.height;e.row.height=t;this._cacheRow=e.row;this._isCheckingHeight=!0;i.refresh();i.startEditing(r);this._isCheckingHeight=!1;e.isImeInput?this._initImeEditInput(e.cell,e.templateContext):this._initEditInput(e.cell,e.templateContext,null);return}}else a&&(e.isImeInput?this._initImeEditInput(e.cell,e.templateContext):this._initEditInput(e.cell,e.templateContext,null))}},2))}}