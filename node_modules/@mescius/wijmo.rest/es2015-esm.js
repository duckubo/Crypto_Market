/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __awaiter=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(s,o){function fulfilled(t){try{step(i.next(t))}catch(t){o(t)}}function rejected(t){try{step(i.throw(t))}catch(t){o(t)}}function step(t){t.done?s(t.value):new r((function(e){e(t.value)})).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))};import{asArray,asBoolean,asInt,copy,clamp,CollectionView,Event,CancelEventArgs,assert,isString,getAggregate,_NullValue,Aggregate,_registerModule}from"@mescius/wijmo";import*as selfModule from"@mescius/wijmo.rest";const _MIN_DATA_WINDOW=100,_overrideError=" method is virtual: it should be overridden";export class RestCollectionView extends CollectionView{constructor(t){super();this._loading=!1;this._fields=null;this._keys=null;this._sortOnServer=!0;this._pageOnServer=!0;this._filterOnServer=!0;this._totalItemCount=0;this._aggregates="";this._groupOnServer=!1;this._groupLazyLoading=!1;this._virtualization=!1;this._start=0;this._end=_MIN_DATA_WINDOW;this._expandedGroups=[];this._groupItems=[];this._groupRefresh=!1;this._refresh=!1;this.loading=new Event;this.loaded=new Event;this.error=new Event;t&&copy(this,t);this.sortDescriptions.collectionChanged.addHandler(()=>{this.sortOnServer&&this._getData()});this._getData();(this._groupOnServer||this._virtualization)&&(this._data=[]);this._virtualization&&this.setWindow(this._start,_MIN_DATA_WINDOW);this._firstLoad=this._groupRefresh=!0}get groupOnServer(){return this._groupOnServer}set groupOnServer(t){if(t!=this._groupOnServer){this._groupOnServer=asBoolean(t);this._getData()}}get groupLazyLoading(){return this._groupLazyLoading}set groupLazyLoading(t){t!=this._groupLazyLoading&&this._groupOnServer&&(this._groupLazyLoading=asBoolean(t))}get virtualization(){return this._virtualization}set virtualization(t){t!=this.virtualization&&(this._virtualization=asBoolean(t))}get fields(){return this._fields}set fields(t){if(this._fields!=t){this._fields=asArray(t);this._getData()}}get sortOnServer(){return this._sortOnServer}set sortOnServer(t){if(t!=this._sortOnServer){this._sortOnServer=asBoolean(t);this._getData()}}get pageOnServer(){return this._pageOnServer}set pageOnServer(t){if(t!=this._pageOnServer){this._pageOnServer=asBoolean(t);this._getData()}}get filterOnServer(){return this._filterOnServer}set filterOnServer(t){if(t!=this._filterOnServer){this._filterOnServer=asBoolean(t);this._getData()}}get requestHeaders(){return this._requestHeaders}set requestHeaders(t){this._requestHeaders=t}get aggregates(){return this._aggregates}set aggregates(t){assert(this._groupOnServer,"groupOnServer should be enabled");isString(t)&&t!=this._aggregates&&(this._aggregates=t)}updateFilterDefinition(t){if(this.filterOnServer){this._filterProvider=t;this._getData()}}lazyLoadGroup(t){if(this._groupLazyLoading){t.groups.length>0&&null==t.groups[0].name&&this._getData(t);0==t.groups.length&&t.isBottomLevel&&this._getData(t)}else assert(this._groupLazyLoading,"groupLazyLoading should be enabled lazy load the groups.")}setWindow(t,e){this._toSetWindow&&clearTimeout(this._toSetWindow);this._toSetWindow=setTimeout(()=>{this._toSetWindow=null;this._performSetWindow(t,e)},50)}_getFilterGroupItems(t){let e=this._groupItems,r=t.items[0];for(let i=0;i<=t.level;i++){let t=this.groupDescriptions[i].propertyName;e=e.filter(e=>e.groupKey[t]==r[t])}return e}getGroupAggregate(t,e,r=Aggregate.Sum){if(this.groupOnServer&&(this.groupLazyLoading||this.virtualization||this.groupDescriptions.length>0&&this._groupItems.length>0)){let i="",s=this._getFilterGroupItems(e);r!=Aggregate.None&&s&&0!=s.length&&s.length!=this._groupItems.length&&s[0].aggregates&&s[0].aggregates.hasOwnProperty(t)&&(i=getAggregate(r,s,`aggregates.${t}`));return i}}get isLoading(){return this._loading}onLoading(t){this.loading.raise(this,t)}onLoaded(t){this.loaded.raise(this,t)}load(){this._getData()}onError(t){this.error.raise(this,t);return!t.cancel}_performRefresh(){this.isLoading||(this._refresh=!0);let t=this._canFilter,e=this._canSort;this._canFilter=!this._filterOnServer;this._canSort=!this._sortOnServer;super._performRefresh();this._canFilter=t;this._canSort=e}get totalItemCount(){return this.pageOnServer?this._totalItemCount:this._view.length}get pageCount(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1}get pageSize(){return this._pgSz}set pageSize(t){if(t!=this._pgSz){this._pgSz=asInt(t);if(this.pageOnServer){this._pgIdx=clamp(this._pgIdx,0,this.pageCount-1);this._getData()}else this.refresh()}}onPageChanging(t){super.onPageChanging(t);this.pageOnServer&&!t.cancel&&this._getData();return!t.cancel}commitNew(){let t=this.currentAddItem;if(t)try{let e=this.addItem(t);e&&e.then&&e.then(()=>this.refresh())}catch(t){let e=t.indexOf(_overrideError)>-1;this._raiseError(t,!e)}super.commitNew()}commitEdit(){let t=this.currentEditItem;if(t&&!this.currentAddItem&&!this._sameContent(t,this._edtClone)&&this.items.indexOf(t)>-1)try{let e=this.patchItem(t);e&&e.then&&e.then(()=>this.refresh())}catch(t){let e=t.indexOf(_overrideError)>-1;this._raiseError(t,!e)}super.commitEdit()}remove(t){if(t&&t!=this.currentAddItem&&this.items.indexOf(t)>-1)try{let e=this.deleteItem(t);e&&e.then&&e.then(()=>this.refresh())}catch(t){let e=t.indexOf(_overrideError)>-1;this._raiseError(t,!e)}super.remove(t)}_getPageView(){return this.pageOnServer?this._view:super._getPageView()}_getData(t){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>__awaiter(this,void 0,void 0,(function*(){this._toGetData=null;this._loading=!0;this.onLoading();let e=null;if(this._groupOnServer||this._virtualization){let e=-1;this.currentPosition>-1&&(e=this.currentPosition);let r=this.groupDescriptions;this._data||(this._data=[]);let i,s=[];if((this._groupRefresh||this._groupLazyLoading&&(!t||!t.isBottomLevel))&&this._groupOnServer&&r.length>0){s=yield this.getGroupItems(t);t?this._updateSubGroups(t,s):this._groupItems=s;this._groupRefresh=!1}this._groupLazyLoading||(i=yield this.getItems());this._groupLazyLoading&&t&&t.isBottomLevel&&(i=yield this.getItems(t));this.deferUpdate(()=>__awaiter(this,void 0,void 0,(function*(){this._virtualization||this._groupLazyLoading||(this._data=i);if(this._groupLazyLoading&&!this._virtualization)if(t)this._loadSubGroupsData(t,s,i);else{this._data=new Array;const e=r[0].propertyName;for(let t=0;t<s.length;t++){let r=new Object,i=s[t].count;r[e]=s[t].groupKey[e];for(let t=0;t<i;t++)this._data.push(r)}this._expandedGroups.length>0&&(yield this._loadExpandedGroups(t))}this._virtualization&&!this._groupLazyLoading&&this._storeItems(i,!1)})));this.sourceCollection=this._data;this.refresh();e>-1&&this.moveCurrentToPosition(e)}else{let t=null;try{let e=this.currentPosition;t=yield this.getItems();this.sourceCollection=t;this.refresh();e>-1&&this.moveCurrentToPosition(e);this.pageIndex>0&&this.pageIndex>=this.pageCount&&this.moveToLastPage()}catch(t){e=t}}this._loading=!1;this.onLoaded();e&&this._raiseError(e,!1)})),100)}_loadExpandedGroups(t){return __awaiter(this,void 0,void 0,(function*(){if(this._expandedGroups.length>0&&!t){let t=[];this._expandedGroups.forEach(e=>__awaiter(this,void 0,void 0,(function*(){e.isBottomLevel?t.push(this.getItems(e)):t.push(this.getGroupItems(e))})));return new Promise(e=>{Promise.all(t).then(t=>{for(let e=0;e<this._expandedGroups.length;e++)if(this._expandedGroups[e].isBottomLevel)this._loadSubGroupsData(this._expandedGroups[e],[],t[e]);else{this._updateSubGroups(this._expandedGroups[e],t[e]);this._loadSubGroupsData(this._expandedGroups[e],t[e],[])}e(!0)}).catch(t=>{e(!1)})})}}))}_updateSubGroups(t,e){let r=this._getFilterGroupItems(t);if(1==r.length){for(let t=0;t<e.length;t++)e[t].groupKey=Object.assign({},r[0].groupKey,e[t].groupKey);let t=this._groupItems.indexOf(r[0]);this._groupItems.splice(t,1,...e)}else console.error("unable to find exact match for targetted group")}_loadSubGroupsData(t,e,r){let i=this.groupDescriptions,s=this._data;for(let e=0;e<=(t.isBottomLevel?i.length-1:t.level);e++){const r=i[e].propertyName,o=t.items[e][r];s=s.filter(t=>t[r]===o)}let o=this._data.indexOf(s[0]);s=JSON.parse(JSON.stringify(s));if(t.isBottomLevel)for(let t=0;t<r.length;t++)Object.assign(s[t],r[t]);else{let r=t.groups[0].groupDescription.propertyName,i=0;for(let t=0;t<e.length;t++){i+=t>0?e[t-1].count:0;for(let o=0;o<e[t].count;o++)s[i+o][r]=e[t].groupKey[r]}}this._data.splice(o,s.length,...s)}_updateExpandedGroups(t,e){if(!this._loading){let r=this._expandedGroups.filter(e=>e._path.indexOf(t._path)>-1);if(e)this._expandedGroups.push(t);else if(r.length>0)for(let t=0;t<r.length;t++)this._expandedGroups.splice(this._expandedGroups.indexOf(r[t]),1)}}_storeItems(t,e){return __awaiter(this,void 0,void 0,(function*(){if(this._refresh||this._data.length!=this.totalItemCount||this.groups&&this.groups.length!=this._totalGroupItemCount){if(this._data.length!=this.totalItemCount&&this.groups&&this.groups.length>0){this._groupRefresh=!0;this._getData()}this._data.length=this.totalItemCount;if(this._groupOnServer&&this._groupItems.length>0&&this.groupDescriptions.length>0){let t=JSON.parse(JSON.stringify(this.groups)),e=0;for(let t=0;t<this._groupItems.length&&this._refresh;t++){let r=Object.keys(this._groupItems[t].groupKey);for(let i=0;i<this._groupItems[t].count;i++){let i=new _NullValue(e);r.forEach(e=>{i[e]=this._groupItems[t].groupKey[e]});this._data[e]=i;e++}}if(0!=this.groups.length&&this.groups.length<t.length){let e=this._data[this._start],r=this.groupDescriptions.length,i=this.groupDescriptions[r-1].propertyName,s=this.groups.findIndex(t=>t.name==e[i]),o=t.findIndex(t=>t.name==e[i]);this._start+=s-o;this._getData()}}else for(let t=0;t<this._data.length;t++)this._data[t]=new _NullValue(t);this._refresh=!1}e||(this._loadOffset=0);let r=this._loadOffset+(this._start||0);for(let e=0;e<t.length;e++)this._data[e+r]=t[e];this._loadOffset+=t.length;setTimeout(()=>{this._firstLoad&&this.currentPosition<0&&t.length&&this.moveCurrentToFirst();this._firstLoad=!1})}))}_isVirtualRefreshNeeded(t,e){t=asInt(t);e=asInt(e);assert(t<=e,"start must be <= end.");let r=this._data;this._start=this._end=t;for(let i=t;i<=e&&i<r.length;i++)if(r[i]instanceof _NullValue){this._start=i;break}for(let t=e;t>=this._start&&t<r.length;t--)if(r[t]instanceof _NullValue){this._end=t;break}return this._start!=this._end||r[this._start]instanceof _NullValue}_performSetWindow(t,e){if(this._pendingReq){this._pendingReq.abort();this._pendingReq=null;this.onRequestCanceled()}let r=t<this._start;if(this._isVirtualRefreshNeeded(t,e)){r&&(this._start=Math.max(0,this._end-this._fetchSize()+1));this._getData()}}_fetchSize(){return Math.max(this._end-this._start+1,this.pageSize,_MIN_DATA_WINDOW)}_raiseError(t,e){if(this.onError(new RESTErrorEventArgs(t))){e&&this._getData();throw"Server Error: "+t}}get requestCanceled(){this._requestCanceled||(this._requestCanceled=new Event);return this._requestCanceled}onRequestCanceled(t){this.requestCanceled.raise(this,t)}getGroupItems(t){throw"The getGroupItems"+_overrideError}getItems(t){throw"The getItems"+_overrideError}addItem(t){throw"The addItem"+_overrideError}patchItem(t){throw"The patchItem"+_overrideError}deleteItem(t){throw"The deleteItem"+_overrideError}}export class RESTErrorEventArgs extends CancelEventArgs{constructor(t){super();this._error=t}get error(){return this._error}}_registerModule("wijmo.rest",selfModule);