/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

import{assert,asType,hasClass,createElement,asBoolean,setChecked,isString,isNumber,copy,closestClass,setAttribute,CollectionView,Event,CancelEventArgs,DataType,isObject,evalTemplate,_CLS_STATE_DISABLED,_registerModule}from"@mescius/wijmo";import{FlexGrid,Column,GroupRow,CellRange,CellFactory,CellEditEndingEventArgs,FormatItemEventArgs,SelectionMode,HeadersVisibility,CellRangeEventArgs,RowColFlags,CellType,_NewRowTemplate}from"@mescius/wijmo.grid";import*as selfModule from"@mescius/wijmo.grid.selector";export const _CLS_CB_ITEM="wj-column-selector";export const _CLS_CB_GROUP="wj-column-selector-group";export class Selector{constructor(e,t){this._col=null;this._grid=null;this._isFixedCol=!1;this._isBound=!1;this._showCheckAll=!0;this._ariaLabel="";this._clickBnd=this._click.bind(this);this._mousedownBnd=this._mousedown.bind(this);this._pressSpaceBnd=this._pressSpace.bind(this);this.columnChanging=new Event;this.columnChanged=new Event;this.itemChecked=new Event;this._initialize();this.column=this._getColumn(e);copy(this,t)}_copy(e,t){if("column"==e&&isObject(t)){this.column=t;return!0}return!1}get column(){return this._col}set column(e){if((e=this._getColumn(e))!=this._col&&this.onColumnChanging(new CancelEventArgs)){let t=this._grid;if(t){let e=t.hostElement;t.formatItem.removeHandler(this._formatItem,this);t.removeEventListener(e,"click",this._clickBnd);t.removeEventListener(e,"mousedown",this._mousedownBnd);t.removeEventListener(e,"keyup",this._pressSpaceBnd)}let i=this._col=asType(e,Column,!0);this._grid=t=i?i.grid:null;this._isFixedCol=!!t&&t.columns.indexOf(i)<0;i&&!this._isBound&&(i.allowMerging=!1);t&&!this._isBound&&(t.selectionMode=SelectionMode.Cell);if(t){let e=t.hostElement;t.formatItem.addHandler(this._formatItem,this);t.addEventListener(e,"click",this._clickBnd,!0);t.addEventListener(e,"mousedown",this._mousedownBnd,!0);t.addEventListener(e,"keyup",this._pressSpaceBnd,!0)}this.onColumnChanged()}}get showCheckAll(){return this._showCheckAll}set showCheckAll(e){if(e!=this._showCheckAll){this._showCheckAll=asBoolean(e);this._grid&&this._grid.invalidate()}}get ariaLabel(){return this._ariaLabel}set ariaLabel(e){e!=this._ariaLabel&&(this._ariaLabel=e)}onColumnChanging(e){this.columnChanging.raise(this,e);return!e.cancel}onColumnChanged(e){this.columnChanged.raise(this,e)}onItemChecked(e){this.itemChecked.raise(this,e)}_initialize(){}_pressSpace(e){if("Space"!==e.code)return;let t=this._grid,i=t.cells.activeCell||e.target,l=this._col,s=t.hitTest(i);if(t.activePanel.getCellElement(t.selection.row,t.selection.col)==i&&l&&s&&s.getColumn()&&s.getColumn()._uid==l._uid){const e=i.querySelector(`.${_CLS_CB_ITEM}`);if(!e)return;e.click()}}_click(e){if(!e.defaultPrevented&&e.target instanceof HTMLElement){let t=this._grid,i=this._col,l=e.target,s=t.hitTest(l);if(i&&s&&s.getColumn()&&s.getColumn()._uid==i._uid){if(l instanceof HTMLInputElement&&hasClass(l,_CLS_CB_ITEM)){let n,o=s.panel.rows,r=o[s.range.topRow];if(o&&t.columnHeaders.rows&&o._uid==t.columnHeaders.rows._uid){n=new CellRange(0,0,t.rows.length-1,0);if(this._isBound){let e=t.selection;e.col=e.col2=i.index;t.select(e)}}else n=this._isGroupRow(r)?r.getCellRange():s.range;if(n.isValid){this._setRangeChecked(l.checked,n);this.onItemChecked()}t.invalidate();e.preventDefault();return}if(hasClass(l,"wj-cell")&&t.bigCheckboxes&&this._isBound&&(this._isFixedCol||this._isGroupRow(s.getRow()))){let t=l.querySelector("input."+_CLS_CB_ITEM);if(t instanceof HTMLInputElement){t.click();e.preventDefault()}}}}}_mousedown(e){let t=this._grid,i=this._col,l=t.editableCollectionView;if(this._isBound&&i&&l&&l.currentEditItem){let l=t.hitTest(e);if(l.getColumn()&&i&&l.getColumn()._uid==i._uid&&this._isGroupRow(l.getRow())){let t=closestClass(e.target,_CLS_CB_GROUP);t instanceof HTMLInputElement&&t.click()}}}_isGroupRow(e){return e instanceof GroupRow&&(!this._grid.childItemsPath||e.getCellRange().rowSpan>1)}_getRowChecked(e,t=e){let i=0,l=0,s=this._col._binding;for(let n=e;n<=t&&(!i||!l);n++){let e=this._grid.rows[n],t=e.dataItem;if(t&&!this._isGroupRow(e)){(this._isBound?s.getValue(t):e.isSelected)?i++:l++}}return!(!i||l)||!(l&&!i)&&null}_setRangeChecked(e,t){let i=this._grid,l=i.rows,s=this._col,n=s?s._binding:null,o=i.selection,r=this._isBound?i.editableCollectionView:null;if(this._isBound&&(i.isReadOnly||!r||!n))return;let a=!1;if(r){let e=!0;r instanceof CollectionView&&!r.refreshOnEdit&&(e=!1);if(e){a=!0;r.beginUpdate()}}i.deferUpdate(()=>{if(r&&r.isEditingItem&&l[0]instanceof _NewRowTemplate){let e=new CellRangeEventArgs(i.cells,i.selection);i.onRowEditEnding(e);r.commitEdit();i.onRowEditEnded(e)}for(let o=t.bottomRow;o>=t.topRow;o--){let t=l[o],a=t.dataItem;if(a)if(this._isGroupRow(t))i.childItemsPath&&!this._isBound&&(t.isSelected=e);else if(this._isBound){if(a[s.binding]!=e){r&&r.editItem(a);let t=new CellRange(o,s.index),l=new CellEditEndingEventArgs(i.cells,t,a[s.binding]);if(i.onCellEditEnding(l)){n.setValue(a,e);i.onCellEditEnded(l)}}}else{let l=new CellRange(t.index,s.index),n=new CellRangeEventArgs(i?i.cells:null,l);if(i.onSelectionChanging(n)&&t._setFlag(RowColFlags.Selected,e,!0)){i.refreshCells(!1,!0,!0);i.onSelectionChanged(n)}}}});if(r){r.commitEdit();a&&r.endUpdate();i.selection=o}}_formatItem(e,t){const i=(t=new FormatItemEventArgs(t.panel,new CellRange(t.range.row,t.range.col,t.range.row2,t.range.col2),t.cell,t.updateContent))._rng;for(;i.col<=i.col2&&!t.getColumn().isVisible;)i.col++;let l=t.getColumn(),s=t.getRow(),n=e.editRange;if(l&&l==this._col&&(t.panel.cellType!==CellType.Cell||!n||!n.contains(t.row,t.col))&&t.panel.rows!=e.columnFooters.rows){let i,n=t.cell,r="",a=CellFactory._tplCtx;a.item=s.dataItem;a.row=s;a.col=l;if(t.panel.rows==e.columnHeaders.rows){if(this._showCheckAll&&t.range.bottomRow==t.panel.rows.length-1){i=this._getRowChecked(0,e.rows.length-1);r=_CLS_CB_ITEM+" "+_CLS_CB_GROUP}}else if(this._isGroupRow(s)){let e=s.getCellRange();i=this._getRowChecked(e.row,e.row2);r=_CLS_CB_ITEM+" "+_CLS_CB_GROUP;s.isSummary&&(r+=" "+_CLS_STATE_DISABLED)}else if(s.dataItem&&!this._isBound){i=this._getRowChecked(t.row);r=_CLS_CB_ITEM}if(r){if(this._isFixedCol||this._isBound&&this._isGroupRow(s)&&l.aggregate&&l.index>e.columns.firstVisibleIndex){let t=n.querySelector("."+CellFactory._WJC_COLLAPSE);e.cellFactory.disposeCell(n);n.textContent="";t&&n.appendChild(t)}var o=""!=this._ariaLabel?' aria-label="'+evalTemplate(this._ariaLabel,a)+'"':' aria-label="Select Row"';let t=createElement('<label><input type="checkbox" class="'+r+" "+CellFactory._WJC_CHECKBOX+'" tabindex="-1"'+o+" /><span></span></label>"),c=t.querySelector("input");setChecked(c,i);s instanceof GroupRow&&s.isSummary&&setAttribute(c,"disabled",!0);setAttribute(n,"aria-selected",!!i);if(this._isBound&&(l.isReadOnly||e.selectionMode==SelectionMode.None)){c.disabled=!0;c.style.cursor="default"}n.insertBefore(t,n.firstChild)}}}_getColumn(e){if(e instanceof FlexGrid){let t=e,i=t.rowHeaders.columns;e=t.headersVisibility&HeadersVisibility.Row&&i.length?i[0]:t.columns[0]}this._grid&&(isString(e)||isNumber(e))&&(e=this._grid.getColumn(e));return e instanceof Column?e:null}}export class BooleanChecker extends Selector{constructor(e,t){super(e,t)}onColumnChanged(e){let t=this.column,i=t?t.dataType:null;assert(!t||null==i||i==DataType.Boolean,"BooleanChecker should be bound to boolean columns");super.onColumnChanged(e)}_initialize(){this._isBound=!0}}_registerModule("wijmo.grid.selector",selfModule);