/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}();import{assert,asType,hasClass,createElement,asBoolean,setChecked,isString,isNumber,copy,closestClass,setAttribute,CollectionView,Event,CancelEventArgs,DataType,isObject,evalTemplate,_CLS_STATE_DISABLED,_registerModule}from"@mescius/wijmo";import{FlexGrid,Column,GroupRow,CellRange,CellFactory,CellEditEndingEventArgs,FormatItemEventArgs,SelectionMode,HeadersVisibility,CellRangeEventArgs,RowColFlags,CellType,_NewRowTemplate}from"@mescius/wijmo.grid";import*as selfModule from"@mescius/wijmo.grid.selector";export var _CLS_CB_ITEM="wj-column-selector";export var _CLS_CB_GROUP="wj-column-selector-group";var Selector=function(){function Selector(e,t){this._col=null;this._grid=null;this._isFixedCol=!1;this._isBound=!1;this._showCheckAll=!0;this._ariaLabel="";this._clickBnd=this._click.bind(this);this._mousedownBnd=this._mousedown.bind(this);this._pressSpaceBnd=this._pressSpace.bind(this);this.columnChanging=new Event;this.columnChanged=new Event;this.itemChecked=new Event;this._initialize();this.column=this._getColumn(e);copy(this,t)}Selector.prototype._copy=function(e,t){if("column"==e&&isObject(t)){this.column=t;return!0}return!1};Object.defineProperty(Selector.prototype,"column",{get:function(){return this._col},set:function(e){if((e=this._getColumn(e))!=this._col&&this.onColumnChanging(new CancelEventArgs)){var t=this._grid;if(t){var i=t.hostElement;t.formatItem.removeHandler(this._formatItem,this);t.removeEventListener(i,"click",this._clickBnd);t.removeEventListener(i,"mousedown",this._mousedownBnd);t.removeEventListener(i,"keyup",this._pressSpaceBnd)}var o=this._col=asType(e,Column,!0);this._grid=t=o?o.grid:null;this._isFixedCol=!!t&&t.columns.indexOf(o)<0;o&&!this._isBound&&(o.allowMerging=!1);t&&!this._isBound&&(t.selectionMode=SelectionMode.Cell);if(t){i=t.hostElement;t.formatItem.addHandler(this._formatItem,this);t.addEventListener(i,"click",this._clickBnd,!0);t.addEventListener(i,"mousedown",this._mousedownBnd,!0);t.addEventListener(i,"keyup",this._pressSpaceBnd,!0)}this.onColumnChanged()}},enumerable:!0,configurable:!0});Object.defineProperty(Selector.prototype,"showCheckAll",{get:function(){return this._showCheckAll},set:function(e){if(e!=this._showCheckAll){this._showCheckAll=asBoolean(e);this._grid&&this._grid.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(Selector.prototype,"ariaLabel",{get:function(){return this._ariaLabel},set:function(e){e!=this._ariaLabel&&(this._ariaLabel=e)},enumerable:!0,configurable:!0});Selector.prototype.onColumnChanging=function(e){this.columnChanging.raise(this,e);return!e.cancel};Selector.prototype.onColumnChanged=function(e){this.columnChanged.raise(this,e)};Selector.prototype.onItemChecked=function(e){this.itemChecked.raise(this,e)};Selector.prototype._initialize=function(){};Selector.prototype._pressSpace=function(e){if("Space"===e.code){var t=this._grid,i=t.cells.activeCell||e.target,o=this._col,n=t.hitTest(i);if(t.activePanel.getCellElement(t.selection.row,t.selection.col)==i&&o&&n&&n.getColumn()&&n.getColumn()._uid==o._uid){var l=i.querySelector("."+_CLS_CB_ITEM);if(!l)return;l.click()}}};Selector.prototype._click=function(e){if(!e.defaultPrevented&&e.target instanceof HTMLElement){var t=this._grid,i=this._col,o=e.target,n=t.hitTest(o);if(i&&n&&n.getColumn()&&n.getColumn()._uid==i._uid){if(o instanceof HTMLInputElement&&hasClass(o,_CLS_CB_ITEM)){var l=void 0,s=n.panel.rows,r=s[n.range.topRow];if(s&&t.columnHeaders.rows&&s._uid==t.columnHeaders.rows._uid){l=new CellRange(0,0,t.rows.length-1,0);if(this._isBound){var a=t.selection;a.col=a.col2=i.index;t.select(a)}}else l=this._isGroupRow(r)?r.getCellRange():n.range;if(l.isValid){this._setRangeChecked(o.checked,l);this.onItemChecked()}t.invalidate();e.preventDefault();return}if(hasClass(o,"wj-cell")&&t.bigCheckboxes&&this._isBound&&(this._isFixedCol||this._isGroupRow(n.getRow()))){var c=o.querySelector("input."+_CLS_CB_ITEM);if(c instanceof HTMLInputElement){c.click();e.preventDefault()}}}}};Selector.prototype._mousedown=function(e){var t=this._grid,i=this._col,o=t.editableCollectionView;if(this._isBound&&i&&o&&o.currentEditItem){var n=t.hitTest(e);if(n.getColumn()&&i&&n.getColumn()._uid==i._uid&&this._isGroupRow(n.getRow())){var l=closestClass(e.target,_CLS_CB_GROUP);l instanceof HTMLInputElement&&l.click()}}};Selector.prototype._isGroupRow=function(e){return e instanceof GroupRow&&(!this._grid.childItemsPath||e.getCellRange().rowSpan>1)};Selector.prototype._getRowChecked=function(e,t){void 0===t&&(t=e);for(var i=0,o=0,n=this._col._binding,l=e;l<=t&&(!i||!o);l++){var s=this._grid.rows[l],r=s.dataItem;if(r&&!this._isGroupRow(s)){(this._isBound?n.getValue(r):s.isSelected)?i++:o++}}return!(!i||o)||!(o&&!i)&&null};Selector.prototype._setRangeChecked=function(e,t){var i=this,o=this._grid,n=o.rows,l=this._col,s=l?l._binding:null,r=o.selection,a=this._isBound?o.editableCollectionView:null;if(!this._isBound||!o.isReadOnly&&a&&s){var c=!1;if(a){var d=!0;a instanceof CollectionView&&!a.refreshOnEdit&&(d=!1);if(d){c=!0;a.beginUpdate()}}o.deferUpdate((function(){if(a&&a.isEditingItem&&n[0]instanceof _NewRowTemplate){var r=new CellRangeEventArgs(o.cells,o.selection);o.onRowEditEnding(r);a.commitEdit();o.onRowEditEnded(r)}for(var c=t.bottomRow;c>=t.topRow;c--){var d=n[c],u=d.dataItem;if(u)if(i._isGroupRow(d))o.childItemsPath&&!i._isBound&&(d.isSelected=e);else if(i._isBound){if(u[l.binding]!=e){a&&a.editItem(u);var h=new CellRange(c,l.index);r=new CellEditEndingEventArgs(o.cells,h,u[l.binding]);if(o.onCellEditEnding(r)){s.setValue(u,e);o.onCellEditEnded(r)}}}else{var _=new CellRange(d.index,l.index);r=new CellRangeEventArgs(o?o.cells:null,_);if(o.onSelectionChanging(r)&&d._setFlag(RowColFlags.Selected,e,!0)){o.refreshCells(!1,!0,!0);o.onSelectionChanged(r)}}}}));if(a){a.commitEdit();c&&a.endUpdate();o.selection=r}}};Selector.prototype._formatItem=function(e,t){for(var i=(t=new FormatItemEventArgs(t.panel,new CellRange(t.range.row,t.range.col,t.range.row2,t.range.col2),t.cell,t.updateContent))._rng;i.col<=i.col2&&!t.getColumn().isVisible;)i.col++;var o=t.getColumn(),n=t.getRow(),l=e.editRange;if(o&&o==this._col&&(t.panel.cellType!==CellType.Cell||!l||!l.contains(t.row,t.col))&&t.panel.rows!=e.columnFooters.rows){var s=t.cell,r="",a=void 0,c=CellFactory._tplCtx;c.item=n.dataItem;c.row=n;c.col=o;if(t.panel.rows==e.columnHeaders.rows){if(this._showCheckAll&&t.range.bottomRow==t.panel.rows.length-1){a=this._getRowChecked(0,e.rows.length-1);r=_CLS_CB_ITEM+" "+_CLS_CB_GROUP}}else if(this._isGroupRow(n)){var d=n.getCellRange();a=this._getRowChecked(d.row,d.row2);r=_CLS_CB_ITEM+" "+_CLS_CB_GROUP;n.isSummary&&(r+=" "+_CLS_STATE_DISABLED)}else if(n.dataItem&&!this._isBound){a=this._getRowChecked(t.row);r=_CLS_CB_ITEM}if(r){if(this._isFixedCol||this._isBound&&this._isGroupRow(n)&&o.aggregate&&o.index>e.columns.firstVisibleIndex){var u=s.querySelector("."+CellFactory._WJC_COLLAPSE);e.cellFactory.disposeCell(s);s.textContent="";u&&s.appendChild(u)}var h=""!=this._ariaLabel?' aria-label="'+evalTemplate(this._ariaLabel,c)+'"':' aria-label="Select Row"',_=createElement('<label><input type="checkbox" class="'+r+" "+CellFactory._WJC_CHECKBOX+'" tabindex="-1"'+h+" /><span></span></label>"),C=_.querySelector("input");setChecked(C,a);n instanceof GroupRow&&n.isSummary&&setAttribute(C,"disabled",!0);setAttribute(s,"aria-selected",!!a);if(this._isBound&&(o.isReadOnly||e.selectionMode==SelectionMode.None)){C.disabled=!0;C.style.cursor="default"}s.insertBefore(_,s.firstChild)}}};Selector.prototype._getColumn=function(e){if(e instanceof FlexGrid){var t=e,i=t.rowHeaders.columns;e=t.headersVisibility&HeadersVisibility.Row&&i.length?i[0]:t.columns[0]}this._grid&&(isString(e)||isNumber(e))&&(e=this._grid.getColumn(e));return e instanceof Column?e:null};return Selector}();export{Selector};var BooleanChecker=function(e){__extends(BooleanChecker,e);function BooleanChecker(t,i){return e.call(this,t,i)||this}BooleanChecker.prototype.onColumnChanged=function(t){var i=this.column,o=i?i.dataType:null;assert(!i||null==o||o==DataType.Boolean,"BooleanChecker should be bound to boolean columns");e.prototype.onColumnChanged.call(this,t)};BooleanChecker.prototype._initialize=function(){this._isBound=!0};return BooleanChecker}(Selector);export{BooleanChecker};_registerModule("wijmo.grid.selector",selfModule);