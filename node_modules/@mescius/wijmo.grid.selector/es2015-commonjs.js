/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)Object.hasOwnProperty.call(e,t)&&(i[t]=e[t]);i.default=e;return i};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("@mescius/wijmo"),wijmo_grid_1=require("@mescius/wijmo.grid"),selfModule=__importStar(require("@mescius/wijmo.grid.selector"));exports._CLS_CB_ITEM="wj-column-selector";exports._CLS_CB_GROUP="wj-column-selector-group";class Selector{constructor(e,i){this._col=null;this._grid=null;this._isFixedCol=!1;this._isBound=!1;this._showCheckAll=!0;this._ariaLabel="";this._clickBnd=this._click.bind(this);this._mousedownBnd=this._mousedown.bind(this);this._pressSpaceBnd=this._pressSpace.bind(this);this.columnChanging=new wijmo_1.Event;this.columnChanged=new wijmo_1.Event;this.itemChecked=new wijmo_1.Event;this._initialize();this.column=this._getColumn(e);wijmo_1.copy(this,i)}_copy(e,i){if("column"==e&&wijmo_1.isObject(i)){this.column=i;return!0}return!1}get column(){return this._col}set column(e){if((e=this._getColumn(e))!=this._col&&this.onColumnChanging(new wijmo_1.CancelEventArgs)){let i=this._grid;if(i){let e=i.hostElement;i.formatItem.removeHandler(this._formatItem,this);i.removeEventListener(e,"click",this._clickBnd);i.removeEventListener(e,"mousedown",this._mousedownBnd);i.removeEventListener(e,"keyup",this._pressSpaceBnd)}let t=this._col=wijmo_1.asType(e,wijmo_grid_1.Column,!0);this._grid=i=t?t.grid:null;this._isFixedCol=!!i&&i.columns.indexOf(t)<0;t&&!this._isBound&&(t.allowMerging=!1);i&&!this._isBound&&(i.selectionMode=wijmo_grid_1.SelectionMode.Cell);if(i){let e=i.hostElement;i.formatItem.addHandler(this._formatItem,this);i.addEventListener(e,"click",this._clickBnd,!0);i.addEventListener(e,"mousedown",this._mousedownBnd,!0);i.addEventListener(e,"keyup",this._pressSpaceBnd,!0)}this.onColumnChanged()}}get showCheckAll(){return this._showCheckAll}set showCheckAll(e){if(e!=this._showCheckAll){this._showCheckAll=wijmo_1.asBoolean(e);this._grid&&this._grid.invalidate()}}get ariaLabel(){return this._ariaLabel}set ariaLabel(e){e!=this._ariaLabel&&(this._ariaLabel=e)}onColumnChanging(e){this.columnChanging.raise(this,e);return!e.cancel}onColumnChanged(e){this.columnChanged.raise(this,e)}onItemChecked(e){this.itemChecked.raise(this,e)}_initialize(){}_pressSpace(e){if("Space"!==e.code)return;let i=this._grid,t=i.cells.activeCell||e.target,o=this._col,l=i.hitTest(t);if(i.activePanel.getCellElement(i.selection.row,i.selection.col)==t&&o&&l&&l.getColumn()&&l.getColumn()._uid==o._uid){const e=t.querySelector(`.${exports._CLS_CB_ITEM}`);if(!e)return;e.click()}}_click(e){if(!e.defaultPrevented&&e.target instanceof HTMLElement){let i=this._grid,t=this._col,o=e.target,l=i.hitTest(o);if(t&&l&&l.getColumn()&&l.getColumn()._uid==t._uid){if(o instanceof HTMLInputElement&&wijmo_1.hasClass(o,exports._CLS_CB_ITEM)){let s,n=l.panel.rows,r=n[l.range.topRow];if(n&&i.columnHeaders.rows&&n._uid==i.columnHeaders.rows._uid){s=new wijmo_grid_1.CellRange(0,0,i.rows.length-1,0);if(this._isBound){let e=i.selection;e.col=e.col2=t.index;i.select(e)}}else s=this._isGroupRow(r)?r.getCellRange():l.range;if(s.isValid){this._setRangeChecked(o.checked,s);this.onItemChecked()}i.invalidate();e.preventDefault();return}if(wijmo_1.hasClass(o,"wj-cell")&&i.bigCheckboxes&&this._isBound&&(this._isFixedCol||this._isGroupRow(l.getRow()))){let i=o.querySelector("input."+exports._CLS_CB_ITEM);if(i instanceof HTMLInputElement){i.click();e.preventDefault()}}}}}_mousedown(e){let i=this._grid,t=this._col,o=i.editableCollectionView;if(this._isBound&&t&&o&&o.currentEditItem){let o=i.hitTest(e);if(o.getColumn()&&t&&o.getColumn()._uid==t._uid&&this._isGroupRow(o.getRow())){let i=wijmo_1.closestClass(e.target,exports._CLS_CB_GROUP);i instanceof HTMLInputElement&&i.click()}}}_isGroupRow(e){return e instanceof wijmo_grid_1.GroupRow&&(!this._grid.childItemsPath||e.getCellRange().rowSpan>1)}_getRowChecked(e,i=e){let t=0,o=0,l=this._col._binding;for(let s=e;s<=i&&(!t||!o);s++){let e=this._grid.rows[s],i=e.dataItem;if(i&&!this._isGroupRow(e)){(this._isBound?l.getValue(i):e.isSelected)?t++:o++}}return!(!t||o)||!(o&&!t)&&null}_setRangeChecked(e,i){let t=this._grid,o=t.rows,l=this._col,s=l?l._binding:null,n=t.selection,r=this._isBound?t.editableCollectionView:null;if(this._isBound&&(t.isReadOnly||!r||!s))return;let _=!1;if(r){let e=!0;r instanceof wijmo_1.CollectionView&&!r.refreshOnEdit&&(e=!1);if(e){_=!0;r.beginUpdate()}}t.deferUpdate(()=>{if(r&&r.isEditingItem&&o[0]instanceof wijmo_grid_1._NewRowTemplate){let e=new wijmo_grid_1.CellRangeEventArgs(t.cells,t.selection);t.onRowEditEnding(e);r.commitEdit();t.onRowEditEnded(e)}for(let n=i.bottomRow;n>=i.topRow;n--){let i=o[n],_=i.dataItem;if(_)if(this._isGroupRow(i))t.childItemsPath&&!this._isBound&&(i.isSelected=e);else if(this._isBound){if(_[l.binding]!=e){r&&r.editItem(_);let i=new wijmo_grid_1.CellRange(n,l.index),o=new wijmo_grid_1.CellEditEndingEventArgs(t.cells,i,_[l.binding]);if(t.onCellEditEnding(o)){s.setValue(_,e);t.onCellEditEnded(o)}}}else{let o=new wijmo_grid_1.CellRange(i.index,l.index),s=new wijmo_grid_1.CellRangeEventArgs(t?t.cells:null,o);if(t.onSelectionChanging(s)&&i._setFlag(wijmo_grid_1.RowColFlags.Selected,e,!0)){t.refreshCells(!1,!0,!0);t.onSelectionChanged(s)}}}});if(r){r.commitEdit();_&&r.endUpdate();t.selection=n}}_formatItem(e,i){const t=(i=new wijmo_grid_1.FormatItemEventArgs(i.panel,new wijmo_grid_1.CellRange(i.range.row,i.range.col,i.range.row2,i.range.col2),i.cell,i.updateContent))._rng;for(;t.col<=t.col2&&!i.getColumn().isVisible;)t.col++;let o=i.getColumn(),l=i.getRow(),s=e.editRange;if(o&&o==this._col&&(i.panel.cellType!==wijmo_grid_1.CellType.Cell||!s||!s.contains(i.row,i.col))&&i.panel.rows!=e.columnFooters.rows){let t,s=i.cell,r="",_=wijmo_grid_1.CellFactory._tplCtx;_.item=l.dataItem;_.row=l;_.col=o;if(i.panel.rows==e.columnHeaders.rows){if(this._showCheckAll&&i.range.bottomRow==i.panel.rows.length-1){t=this._getRowChecked(0,e.rows.length-1);r=exports._CLS_CB_ITEM+" "+exports._CLS_CB_GROUP}}else if(this._isGroupRow(l)){let e=l.getCellRange();t=this._getRowChecked(e.row,e.row2);r=exports._CLS_CB_ITEM+" "+exports._CLS_CB_GROUP;l.isSummary&&(r+=" "+wijmo_1._CLS_STATE_DISABLED)}else if(l.dataItem&&!this._isBound){t=this._getRowChecked(i.row);r=exports._CLS_CB_ITEM}if(r){if(this._isFixedCol||this._isBound&&this._isGroupRow(l)&&o.aggregate&&o.index>e.columns.firstVisibleIndex){let i=s.querySelector("."+wijmo_grid_1.CellFactory._WJC_COLLAPSE);e.cellFactory.disposeCell(s);s.textContent="";i&&s.appendChild(i)}var n=""!=this._ariaLabel?' aria-label="'+wijmo_1.evalTemplate(this._ariaLabel,_)+'"':' aria-label="Select Row"';let i=wijmo_1.createElement('<label><input type="checkbox" class="'+r+" "+wijmo_grid_1.CellFactory._WJC_CHECKBOX+'" tabindex="-1"'+n+" /><span></span></label>"),a=i.querySelector("input");wijmo_1.setChecked(a,t);l instanceof wijmo_grid_1.GroupRow&&l.isSummary&&wijmo_1.setAttribute(a,"disabled",!0);wijmo_1.setAttribute(s,"aria-selected",!!t);if(this._isBound&&(o.isReadOnly||e.selectionMode==wijmo_grid_1.SelectionMode.None)){a.disabled=!0;a.style.cursor="default"}s.insertBefore(i,s.firstChild)}}}_getColumn(e){if(e instanceof wijmo_grid_1.FlexGrid){let i=e,t=i.rowHeaders.columns;e=i.headersVisibility&wijmo_grid_1.HeadersVisibility.Row&&t.length?t[0]:i.columns[0]}this._grid&&(wijmo_1.isString(e)||wijmo_1.isNumber(e))&&(e=this._grid.getColumn(e));return e instanceof wijmo_grid_1.Column?e:null}}exports.Selector=Selector;class BooleanChecker extends Selector{constructor(e,i){super(e,i)}onColumnChanged(e){let i=this.column,t=i?i.dataType:null;wijmo_1.assert(!i||null==t||t==wijmo_1.DataType.Boolean,"BooleanChecker should be bound to boolean columns");super.onColumnChanged(e)}_initialize(){this._isBound=!0}}exports.BooleanChecker=BooleanChecker;wijmo_1._registerModule("wijmo.grid.selector",selfModule);