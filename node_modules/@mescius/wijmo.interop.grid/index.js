/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}(),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&(t[i]=e[i]);t.default=e;return t};Object.defineProperty(exports,"__esModule",{value:!0});var wijmo_1=require("@mescius/wijmo"),wjcCore=__importStar(require("@mescius/wijmo")),wjcGrid=__importStar(require("@mescius/wijmo.grid")),selfModule=__importStar(require("@mescius/wijmo.interop.grid"));function softInput(){return wijmo_1._getModule("wijmo.input")}exports.softInput=softInput;function softGridDetail(){return wijmo_1._getModule("wijmo.grid.detail")}exports.softGridDetail=softGridDetail;var __gridCFRef=wjcGrid&&wjcGrid.CellFactory;if(!__gridCFRef){window.wijmo.grid={};window.wijmo.grid.CellFactory=function(){}}var GridCellTemplateType,DirectiveCellFactoryBase=function(e){__extends(DirectiveCellFactoryBase,e);function DirectiveCellFactoryBase(t){var i=e.call(this)||this;i._lastApplyTimeStamp=0;i._noApplyLag=!1;i._startingEditing=!1;i._cellStampCounter=0;i._composing=!1;i._autoSizeCache={};i._isCheckingHeight=!1;i._backupHeight=-1;i._cacheRow=null;i.grid=t;if(!DirectiveCellFactoryBase._templateTypes){DirectiveCellFactoryBase._templateTypes=[];for(var l in GridCellTemplateType)isNaN(l)&&DirectiveCellFactoryBase._templateTypes.push(l)}var r=i;i._baseCf=t.cellFactory;t.cellFactory=i;i._evtInput=document.createEvent("HTMLEvents");i._evtInput.initEvent("input",!0,!1);i._evtBlur=document.createEvent("HTMLEvents");i._evtBlur.initEvent("blur",!1,!1);t.prepareCellForEdit.addHandler((function(e,t){r._noApplyLag=!0}));t.cellEditEnded.addHandler((function(e,i){var l=i.range,o=l.col;(o<0||o<t.columns.length&&!t._getBindingColumn(t.cells,l.row,t.columns[o])[DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType.CellEdit)])&&(r._editChar=null);setTimeout((function(){r._noApplyLag=!1}),300)}));t.beginningEdit.addHandler((function(e,t){r._startingEditing=!0}));t.hostElement.addEventListener("keydown",(function(e){r._startingEditing=!1}),!0);t.hostElement.addEventListener("keypress",(function(e){var i=e.charCode>32?String.fromCharCode(e.charCode):null;if(i&&wjcCore.closest(e.target,".wj-flexgrid")===t.hostElement)if(!t.activeEditor||r._startingEditing){r._editChar=i;setTimeout((function(){t.activeEditor||(r._editChar=null)}),0)}else r._editChar&&(r._editChar+=i)}),!0);t.hostElement.addEventListener("compositionstart",(function(e){r._composing=!0}),!0);t.hostElement.addEventListener("compositionend",(function(e){r._composing=!1}),!0);t.updatedView.addHandler((function(e,t){i._updatedViewHandler()}));return i}DirectiveCellFactoryBase.prototype._updatedViewHandler=function(){var e=this;queueMicrotask((function(){e._autoSizeIfRequired()}))};DirectiveCellFactoryBase.prototype.canRender=function(e){return!!e};DirectiveCellFactoryBase.prototype.updateCell=function(e,t,i,l,r){this._cellStampCounter=(this._cellStampCounter+1)%1e7;l[DirectiveCellFactoryBase._cellStampProp]=this._cellStampCounter;l.style.overflow&&(l.style.overflow="");var o=t,a=i;if(r&&!r.isSingleCell){t=r.row;i=r.col}var n,s=e.grid,c=s.editRange,d=e.rows[t],p=d.dataItem,u=!1,C=!1,h=!1,g=!1;switch(e.cellType){case wjcGrid.CellType.Cell:if(c&&c.row===t&&c.col===i){n=GridCellTemplateType.CellEdit;C=h=!0}else if(d instanceof wjcGrid.GroupRow){var m=!((g=p instanceof wjcCore.CollectionViewGroup)||d.hasChildren);if(i==e.columns.firstVisibleIndex)n=m?GridCellTemplateType.Cell:GridCellTemplateType.GroupHeader;else{n=m?GridCellTemplateType.Cell:GridCellTemplateType.Group;C=!0}}else d instanceof wjcGrid._NewRowTemplate?n=GridCellTemplateType.NewCellTemplate:softGridDetail()&&softGridDetail().DetailRow&&d instanceof softGridDetail().DetailRow||(n=GridCellTemplateType.Cell);break;case wjcGrid.CellType.ColumnHeader:n=GridCellTemplateType.ColumnHeader;break;case wjcGrid.CellType.RowHeader:n=s.collectionView&&s.collectionView.currentEditItem===p?GridCellTemplateType.RowHeaderEdit:GridCellTemplateType.RowHeader;u=!0;break;case wjcGrid.CellType.TopLeft:n=GridCellTemplateType.TopLeft;u=!0;break;case wjcGrid.CellType.ColumnFooter:n=GridCellTemplateType.ColumnFooter;C=!0;break;case wjcGrid.CellType.BottomLeft:n=GridCellTemplateType.BottomLeft;u=!0}var f=!1;if(null!=n){var _=null;g&&n==GridCellTemplateType.GroupHeader?_=s.getColumn(p.groupDescription.propertyName):i>=0&&i<e.columns.length&&(_=e.cellType===wjcGrid.CellType.ColumnHeader&&s._hasColumnGroups()?s._getColumnGroup(t,i):s._getBindingColumn(e,t,e.columns[i]));if(_){var y=DirectiveCellFactoryBase.getTemplContextProp,v=y(n),w=(u?s:_)[v];w||(n===GridCellTemplateType.RowHeaderEdit?w=s[v=y(n=GridCellTemplateType.RowHeader)]:n!==GridCellTemplateType.Group&&n!==GridCellTemplateType.GroupHeader||g||(w=_[v=y(n=GridCellTemplateType.Cell)]));w&&this.canRender(w)&&(f=this._processTemplate(e,t,i,l,w,{needCellValue:C,isCvGroup:g,isEdit:h,riOriginal:o,ciOriginal:a,rng:r,templContextProp:v,col:_,row:d}))}}if(!f){this._doDisposeCell(l);this._baseCf.updateCell(e,o,a,l,r)}};DirectiveCellFactoryBase.prototype._processTemplate=function(e,t,i,l,r,o){var a,n,s=this,c=o.needCellValue,d=o.isCvGroup,p=o.isEdit,u=e.grid,C=o.row,h=o.col,g=o.riOriginal,m=o.ciOriginal,f=o.rng,_=o.templContextProp,y=l[DirectiveCellFactoryBase._cellStampProp],v=this;if(c){a=e.getCellData(t,i,!1);n=e.getCellData(t,i,!0)}var w=!!d&&C.isSummary,E=d&&(u.groupSummaryPosition===wjcGrid.GroupSummaryPosition.Bottom||u.groupSummaryPosition===wjcGrid.GroupSummaryPosition.Auto&&!C.isCollapsed),T=l.getAttribute(wjcGrid.FlexGrid._WJS_MEASURE),S=T&&"true"===T.toLowerCase();if(p){this.clearCell(l);this._baseCf.updateCell(e,g,m,l,f,!0)}var F,H=p&&u.imeEnabled,G=H&&this._composing,D=l[_],j={cell:l,column:h,row:C,panel:e,rng:f,isEdit:p,isImeInput:H,isTrueImeInput:G,templateContext:r,templateCache:D,templateContextProperty:_,cellStamp:y,cellValue:a,cellValueFormatted:n},B=this.shouldInstantiate(j),z=!0;d&&!w&&i!=e.columns.firstVisibleIndex&&E&&(z=!1);if(B){if(p){var R=l.firstElementChild;if(R){H||l.focus();R.style.display="none"}}else this.clearCell(l);this._doDisposeCell(l);if(z){this.renderTemplate(j,!0);j.templateCache=D=l[_]}F=j.cellBindingsData}else{z?this.renderTemplate(j,!1):this._doDisposeCell(l);F=j.cellBindingsData}r.cellOverflow&&(l.style.overflow=r.cellOverflow);S?this.applyImmediately(j):r.autoSizeRows&&!H&&this._markForAutoSize(t,i,e);if(p){z&&queueMicrotask((function(){s._updateEditRowSize(e,t,i,l)}));setTimeout((function(){H?s._initImeEditInput(j.cell,r):s._initEditInput(j.cell,r,null)}),0)}if(p){v._cellEditorVars=F.localVars;var editEndingEH=function(e,t){u.cellEditEnding.removeHandler(editEndingEH);if(!t.stayInEditMode){var i=wjcCore.getActiveElement();i&&i.dispatchEvent(v._evtBlur);wjcCore.contains(l,wjcCore.getActiveElement())&&l.focus()}v._triggerEditorEvents(l);if(!t.cancel&&!t.stayInEditMode)for(var r=F.localVars,o=0,a=Object.getOwnPropertyNames(F.bindings);o<a.length;o++){var n=a[o];F.bindings[n].setValue(r,F.localVars.values[n])}var s=l.querySelectorAll(".wj-dropdown");[].forEach.call(s,(function(e){var t=wjcCore.Control.getControl(e);t&&softInput()&&t instanceof softInput().DropDown&&(t.isDroppedDown=!1)}))},editEndedEH_1=function(e,t){u.cellEditEnded.removeHandler(editEndedEH_1);v._cellEditorVars=null};u.cellEditEnding.addHandler(editEndingEH);u.cellEditEnded.addHandler(editEndedEH_1)}else this._baseCf.updateCell(e,g,m,l,f,!1);return!0};DirectiveCellFactoryBase.prototype._updateEditRowSize=function(e,t,i,l){var r=this,o=e.rows[t],a=this.getHeight(e,t,i,l),n=0;if(this.grid.rowHeaders.columns[0]&&this.grid.rowHeaders.columns[0].isVisible)try{n=this.getHeight(this.grid.rowHeaders,t,0,this.grid.rowHeaders.getCellElement(t,0))}catch(e){}n>a&&(a=n);if(!o.resizedManually&&a>o.renderHeight){var s=o.height;o.height=a;if(this.grid._toInv){clearTimeout(this.grid._toInv);this.grid._listenResizeEvents=!1;this.grid.refreshCells(!0);setTimeout((function(){r.grid._listenResizeEvents=!0}))}var endedHandler_1=function(e,i){o._editHandler=null;e.rowEditEnded.removeHandler(endedHandler_1);e.rows[t]&&(e.rows[t].height=s||null)};if(!o._editHandler){o._editHandler=endedHandler_1;this.grid.rowEditEnded.addHandler(endedHandler_1)}}};DirectiveCellFactoryBase.prototype._autoSizePanelCells=function(e,t,i){for(var l,r=!1,o=0,a=!1,n=e.grid.editableCollectionView&&e.grid.editableCollectionView.currentEditItem,s=0,c=e.columns;s<c.length;s++){c[s].isVisible&&o++}for(var d=0,p=t.columns;d<p.length;d++){if(p[d].isVisible){a=!0;break}}var u=e.rows.defaultSize;for(l in i){l=parseInt(l);if(e.rows[l]&&(!n||e.rows[l].dataItem!==n)&&(!e.rows[l].resizedManually&&null==e.rows[l].detail)){for(var C=Array.from(i[l].rowHeader),h=Array.from(i[l].cell),g=-1,m=0,f=C;m<f.length;m++){var _=f[m];if((w=t.getCellElement(l,_))&&(!w.$__cellTemplRowHeaderEdit||w.$__cellTemplRowHeaderEdit&&n)){(E=this.getHeight(t,l,_,w))>g&&(g=E)}}for(var y=0,v=h;y<v.length;y++){var w;_=v[y];if(w=e.getCellElement(l,_)){var E;(E=this.getHeight(e,l,_,w))>g&&(g=E)}}h.length!=o&&u>g&&(g=u);e.grid.headersVisibility&wjcGrid.HeadersVisibility.Row&&a&&0===C.length&&u>g&&(g=u);if(g>-1&&Math.abs(e.rows[l].height-g)>1){e.rows[l].height=g;r=!0}}}return r};DirectiveCellFactoryBase.prototype.getHeight=function(e,t,i,l){var r=l.scrollHeight,o=e.rows,a=e.grid.getMergedRange(e,t,i,!1),n=a&&a.rowSpan||1;if(l.firstElementChild){var s=getComputedStyle(l),c=(parseFloat(s.paddingTop)||0)+(parseFloat(s.paddingBottom)||0),d=(parseFloat(s.borderBottomWidth)||0)+(parseFloat(s.borderTopWidth)||0),p=l.firstElementChild.scrollHeight+c+d;l.firstElementChild.childNodes.length>0&&0!=l.firstElementChild.scrollHeight&&(r=p)}null!=o.maxSize&&(r=Math.min(r,o.maxSize));return r/n};DirectiveCellFactoryBase.prototype._autoSizeIfRequired=function(){var e=this.grid.editRange;if(e&&this.grid.columns[e.col]||this.grid._mouseHdl._isDown&&this.grid._mouseHdl._szArgs)this._autoSizeCache={};else{var t=this.grid.viewRange;if(this._autoSizeCache&&this._autoSizeCache.pendingCells)for(var i=t.topRow;i<=t.bottomRow;i++){if(this._autoSizeCache.pendingCells.cells&&this._autoSizeCache.pendingCells.cells[i]){this._autoSizePendingCells();return}if(this._autoSizeCache.pendingCells.headers&&this._autoSizeCache.pendingCells.headers[i]){this._autoSizePendingCells();return}if(this._autoSizeCache.pendingCells.footers&&this._autoSizeCache.pendingCells.footers[i]){this._autoSizePendingCells();return}}}};DirectiveCellFactoryBase.prototype._autoSizePendingCells=function(){var e=!1,t=!1,i=!1;try{this.grid.beginUpdate();if(!this._autoSizeCache||!this._autoSizeCache.pendingCells)return;this._autoSizeCache.pendingCells.headers&&(e=this._autoSizePanelCells(this.grid.columnHeaders,this.grid.topLeftCells,this._autoSizeCache.pendingCells.headers));this._autoSizeCache.pendingCells.cells&&(t=this._autoSizePanelCells(this.grid.cells,this.grid.rowHeaders,this._autoSizeCache.pendingCells.cells));this._autoSizeCache.pendingCells.footers&&(i=this._autoSizePanelCells(this.grid.columnFooters,this.grid.bottomLeftCells,this._autoSizeCache.pendingCells.footers));this._autoSizeCache={}}finally{this.grid.endUpdate(e||t||i)}};DirectiveCellFactoryBase.prototype._markForAutoSize=function(e,t,i){var l,r=!1;this._autoSizeCache.pendingCells||(this._autoSizeCache.pendingCells={});switch(i.cellType){case wjcGrid.CellType.TopLeft:r=!0;case wjcGrid.CellType.ColumnHeader:this._autoSizeCache.pendingCells.headers||(this._autoSizeCache.pendingCells.headers={});l=this._autoSizeCache.pendingCells.headers;break;case wjcGrid.CellType.RowHeader:r=!0;case wjcGrid.CellType.Cell:this._autoSizeCache.pendingCells.cells||(this._autoSizeCache.pendingCells.cells={});l=this._autoSizeCache.pendingCells.cells;break;case wjcGrid.CellType.BottomLeft:r=!0;case wjcGrid.CellType.ColumnFooter:this._autoSizeCache.pendingCells.footers||(this._autoSizeCache.pendingCells.footers={});l=this._autoSizeCache.pendingCells.footers;break;default:return}l[e]||(l[e]={rowHeader:new Set,cell:new Set});r?l[e].rowHeader.add(t):l[e].cell.add(t)};DirectiveCellFactoryBase.prototype.getEditorValue=function(t){if(this._cellEditorVars){var i=t.editRange;i&&i.isValid&&this._triggerEditorEvents(t.cells.getCellElement(i.row,i.col));return this._cellEditorVars.value}return e.prototype.getEditorValue.call(this,t)};DirectiveCellFactoryBase.prototype.disposeCell=function(e){this._doDisposeCell(e)};DirectiveCellFactoryBase.prototype.disposeTemplate=function(e,t,i){if(t){t.rootElement=null;t.column=null;e[t.templateContextProperty]=null;t.templateContextProperty=null}};DirectiveCellFactoryBase.prototype.setBindingsData=function(e,t,i,l,r,o){e.row=t;e.col=i;e.item=l;var a={},n=e.cell||{},s={},c={localVars:n,bindings:s};n.row=t;n.col=i;n.item=l;n.value=r;n.valueFormatted=e.cellValueFormatted;n.values=a;if(o)for(var d=0,p=Object.getOwnPropertyNames(o);d<p.length;d++){var u=p[d],C=new wjcCore.Binding(o[u]);s[u]=C;a[u]=C.getValue(n)}e.cell!==n&&(e.cell=n);return c};DirectiveCellFactoryBase.prototype.checkHeight=function(e){var t=this;this._isCheckingHeight||setTimeout((function(){var i=e.cell;if(e.cellStamp===i[DirectiveCellFactoryBase._cellStampProp]){var l=i.scrollHeight,r=e.panel.rows,o=e.row.index,a=e.rng,n=a&&a.rowSpan||1,s=e.isEdit;null!=r.maxSize&&(l=Math.min(l,r.maxSize));if(o<r.length&&r[o].renderHeight*n<l-1){var c=l/n;if(s){var d=t._isFullEdit(),p=t.grid;t._backupHeight=e.row.height;e.row.height=c;t._cacheRow=e.row;t._isCheckingHeight=!0;p.refresh();p.startEditing(d);t._isCheckingHeight=!1}}s&&(e.isImeInput?t._initImeEditInput(e.cell,e.templateContext):t._initEditInput(e.cell,e.templateContext,null))}}),0)};DirectiveCellFactoryBase.prototype._restoreRowHeight=function(){if(!this._isCheckingHeight&&this._cacheRow){this._cacheRow.height=this._backupHeight;this._backupHeight=-1;this._cacheRow=null}};DirectiveCellFactoryBase.prototype.doDisposeCell=function(e){for(var t=DirectiveCellFactoryBase._templateTypes,i=0;i<t.length;i++){var l=DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType[t[i]]),r=e[l];if(r){var o=(r.column||this.grid)[l];this.disposeTemplate(e,r,o);t[i]==GridCellTemplateType[GridCellTemplateType.CellEdit]&&this._restoreRowHeight()}}};DirectiveCellFactoryBase.getTemplContextProp=function(e){return"$__cellTempl"+GridCellTemplateType[e]};DirectiveCellFactoryBase.prototype._doDisposeCell=function(e){this.doDisposeCell(e)};DirectiveCellFactoryBase.prototype._initEditInput=function(e,t,i){var l=this;this.setEditorFocusFlag(!0);var r=!1!==this.getEditorFocusFlag();this.setEditorFocusFlag(null);this._setFullEdit(t);if(r){var o=this._findInitialInput(e);if(o){var inpFocusEh=function(){o.removeEventListener("focus",inpFocusEh);setTimeout((function(){var e=null!=i?i:l._editChar;if(e){o.value=e;l._editChar=null;DirectiveCellFactoryBase._setSelectionRange(o,e.length,e.length);o.dispatchEvent(l._evtInput)}}),DirectiveCellFactoryBase._FOCUS_INTERVAL)};o.addEventListener("focus",inpFocusEh);o.focus()}}};DirectiveCellFactoryBase.prototype._initImeEditInput=function(e,t){var i=this,l=wjcCore.getActiveElement();if(l&&(l instanceof HTMLInputElement||l instanceof HTMLTextAreaElement)&&wjcCore.hasClass(l,"wj-grid-ime")){var r=this._findInitialInput(e),o=r&&r.style.color,a=this._composing,compEndEh_1=function(){l.removeEventListener("compositionend",compEndEh_1);wjcCore.setCss(l,wjcGrid._ImeHandler._cssHidden);i.setEditorFocusFlag(!0);r&&(r.style.color=o);i._initEditInput(e,t,a?l.value:null)};if(a){l.addEventListener("compositionend",compEndEh_1);if(r){var n=r.getBoundingClientRect(),s=l.getBoundingClientRect(),c=window.getComputedStyle(l),d=parseFloat(c.left),p=parseFloat(c.top);wjcCore.setCss(l,{left:d+n.left-s.left+"px",top:p+n.top-s.top+"px",width:n.width+"px",height:n.height+"px"});r.style.color="transparent"}}else setTimeout((function(){return compEndEh_1()}),DirectiveCellFactoryBase._FOCUS_INTERVAL)}};DirectiveCellFactoryBase.prototype._findInitialInput=function(e){var t=e&&e.rootElement&&e.rootElement.querySelectorAll("input,textarea")||e&&e.querySelectorAll("input,textarea");if(t)for(var i=0;i<t.length;i++){var l=t[i],r=window.getComputedStyle(l);if("none"!==r.display&&"visible"===r.visibility)return l}return null};DirectiveCellFactoryBase._setSelectionRange=function(e,t,i){void 0===i&&(i=t);if(wjcCore.contains(document.body,e)&&!e.disabled&&"none"!=e.style.display)try{e.setSelectionRange(wjcCore.asNumber(t),wjcCore.asNumber(i),wjcCore.isIE()?null:"backward");e.focus()}catch(e){}};DirectiveCellFactoryBase.prototype._triggerEditorEvents=function(e){if(e)for(var t=e.querySelectorAll(".wj-control"),i=0;i<t.length;i++){var l=t[i],r=wjcCore.Control.getControl(l);r&&this.flushPendingEvents(r)}};DirectiveCellFactoryBase.prototype._isFullEdit=function(){var e=this.grid;return!e.activeEditor||e._edtHdl._fullEdit};DirectiveCellFactoryBase.prototype._setFullEdit=function(e){var t=this.grid;e.forceFullEdit&&t.activeEditor&&(t._edtHdl._fullEdit=!0)};DirectiveCellFactoryBase._cellStampProp="__wjCellStamp";DirectiveCellFactoryBase._FOCUS_INTERVAL=wjcCore.Control._FOCUS_INTERVAL+20;return DirectiveCellFactoryBase}(wjcGrid.CellFactory);exports.DirectiveCellFactoryBase=DirectiveCellFactoryBase;__gridCFRef||(window.wijmo.grid=null);!function(e){e[e.Cell=0]="Cell";e[e.CellEdit=1]="CellEdit";e[e.ColumnHeader=2]="ColumnHeader";e[e.RowHeader=3]="RowHeader";e[e.RowHeaderEdit=4]="RowHeaderEdit";e[e.TopLeft=5]="TopLeft";e[e.GroupHeader=6]="GroupHeader";e[e.Group=7]="Group";e[e.NewCellTemplate=8]="NewCellTemplate";e[e.ColumnFooter=9]="ColumnFooter";e[e.BottomLeft=10]="BottomLeft"}(GridCellTemplateType=exports.GridCellTemplateType||(exports.GridCellTemplateType={}));wijmo_1._registerModule("wijmo.interop.grid",selfModule);