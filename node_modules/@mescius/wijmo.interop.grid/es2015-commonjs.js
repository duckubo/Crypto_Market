/*!
    *
    * Wijmo Library 5.20242.21
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&(t[i]=e[i]);t.default=e;return t};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("@mescius/wijmo"),wjcCore=__importStar(require("@mescius/wijmo")),wjcGrid=__importStar(require("@mescius/wijmo.grid")),selfModule=__importStar(require("@mescius/wijmo.interop.grid"));function softInput(){return wijmo_1._getModule("wijmo.input")}exports.softInput=softInput;function softGridDetail(){return wijmo_1._getModule("wijmo.grid.detail")}exports.softGridDetail=softGridDetail;var GridCellTemplateType,__gridCFRef=wjcGrid&&wjcGrid.CellFactory;if(!__gridCFRef){window.wijmo.grid={};window.wijmo.grid.CellFactory=function(){}}class DirectiveCellFactoryBase extends wjcGrid.CellFactory{constructor(e){super();this._lastApplyTimeStamp=0;this._noApplyLag=!1;this._startingEditing=!1;this._cellStampCounter=0;this._composing=!1;this._autoSizeCache={};this._isCheckingHeight=!1;this._backupHeight=-1;this._cacheRow=null;this.grid=e;if(!DirectiveCellFactoryBase._templateTypes){DirectiveCellFactoryBase._templateTypes=[];for(var t in GridCellTemplateType)isNaN(t)&&DirectiveCellFactoryBase._templateTypes.push(t)}var i=this;this._baseCf=e.cellFactory;e.cellFactory=this;this._evtInput=document.createEvent("HTMLEvents");this._evtInput.initEvent("input",!0,!1);this._evtBlur=document.createEvent("HTMLEvents");this._evtBlur.initEvent("blur",!1,!1);e.prepareCellForEdit.addHandler((function(e,t){i._noApplyLag=!0}));e.cellEditEnded.addHandler((function(t,l){let r=l.range,o=r.col;(o<0||o<e.columns.length&&!e._getBindingColumn(e.cells,r.row,e.columns[o])[DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType.CellEdit)])&&(i._editChar=null);setTimeout((function(){i._noApplyLag=!1}),300)}));e.beginningEdit.addHandler((function(e,t){i._startingEditing=!0}));e.hostElement.addEventListener("keydown",(function(e){i._startingEditing=!1}),!0);e.hostElement.addEventListener("keypress",(function(t){var l=t.charCode>32?String.fromCharCode(t.charCode):null;if(l&&wjcCore.closest(t.target,".wj-flexgrid")===e.hostElement)if(!e.activeEditor||i._startingEditing){i._editChar=l;setTimeout(()=>{e.activeEditor||(i._editChar=null)},0)}else i._editChar&&(i._editChar+=l)}),!0);e.hostElement.addEventListener("compositionstart",(function(e){i._composing=!0}),!0);e.hostElement.addEventListener("compositionend",(function(e){i._composing=!1}),!0);e.updatedView.addHandler((e,t)=>{this._updatedViewHandler()})}_updatedViewHandler(){queueMicrotask(()=>{this._autoSizeIfRequired()})}canRender(e){return!!e}updateCell(e,t,i,l,r){this._cellStampCounter=(this._cellStampCounter+1)%1e7;l[DirectiveCellFactoryBase._cellStampProp]=this._cellStampCounter;l.style.overflow&&(l.style.overflow="");let o=t,s=i;if(r&&!r.isSingleCell){t=r.row;i=r.col}let a,n=e.grid,d=n.editRange,c=e.rows[t],p=c.dataItem,u=!1,h=!1,C=!1,m=!1;switch(e.cellType){case wjcGrid.CellType.Cell:if(d&&d.row===t&&d.col===i){a=GridCellTemplateType.CellEdit;h=C=!0}else if(c instanceof wjcGrid.GroupRow){var g=!((m=p instanceof wjcCore.CollectionViewGroup)||c.hasChildren);if(i==e.columns.firstVisibleIndex)a=g?GridCellTemplateType.Cell:GridCellTemplateType.GroupHeader;else{a=g?GridCellTemplateType.Cell:GridCellTemplateType.Group;h=!0}}else c instanceof wjcGrid._NewRowTemplate?a=GridCellTemplateType.NewCellTemplate:softGridDetail()&&softGridDetail().DetailRow&&c instanceof softGridDetail().DetailRow||(a=GridCellTemplateType.Cell);break;case wjcGrid.CellType.ColumnHeader:a=GridCellTemplateType.ColumnHeader;break;case wjcGrid.CellType.RowHeader:a=n.collectionView&&n.collectionView.currentEditItem===p?GridCellTemplateType.RowHeaderEdit:GridCellTemplateType.RowHeader;u=!0;break;case wjcGrid.CellType.TopLeft:a=GridCellTemplateType.TopLeft;u=!0;break;case wjcGrid.CellType.ColumnFooter:a=GridCellTemplateType.ColumnFooter;h=!0;break;case wjcGrid.CellType.BottomLeft:a=GridCellTemplateType.BottomLeft;u=!0}var _=!1;if(null!=a){let d=null;m&&a==GridCellTemplateType.GroupHeader?d=n.getColumn(p.groupDescription.propertyName):i>=0&&i<e.columns.length&&(d=e.cellType===wjcGrid.CellType.ColumnHeader&&n._hasColumnGroups()?n._getColumnGroup(t,i):n._getBindingColumn(e,t,e.columns[i]));if(d){var f=DirectiveCellFactoryBase.getTemplContextProp,w=f(a),E=(u?n:d)[w];E||(a===GridCellTemplateType.RowHeaderEdit?E=n[w=f(a=GridCellTemplateType.RowHeader)]:a!==GridCellTemplateType.Group&&a!==GridCellTemplateType.GroupHeader||m||(E=d[w=f(a=GridCellTemplateType.Cell)]));E&&this.canRender(E)&&(_=this._processTemplate(e,t,i,l,E,{needCellValue:h,isCvGroup:m,isEdit:C,riOriginal:o,ciOriginal:s,rng:r,templContextProp:w,col:d,row:c}))}}if(!_){this._doDisposeCell(l);this._baseCf.updateCell(e,o,s,l,r)}}_processTemplate(e,t,i,l,r,o){let s=o.needCellValue,a=o.isCvGroup,n=o.isEdit,d=e.grid,c=o.row,p=o.col,u=o.riOriginal,h=o.ciOriginal,C=o.rng,m=o.templContextProp;const g=l[DirectiveCellFactoryBase._cellStampProp],_=this;let f,w;if(s){f=e.getCellData(t,i,!1);w=e.getCellData(t,i,!0)}const E=!!a&&c.isSummary,y=a&&(d.groupSummaryPosition===wjcGrid.GroupSummaryPosition.Bottom||d.groupSummaryPosition===wjcGrid.GroupSummaryPosition.Auto&&!c.isCollapsed);let T=l.getAttribute(wjcGrid.FlexGrid._WJS_MEASURE),v=T&&"true"===T.toLowerCase();if(n){this.clearCell(l);this._baseCf.updateCell(e,u,h,l,C,!0)}let S,H=n&&d.imeEnabled,G=H&&this._composing,j=l[m],F={cell:l,column:p,row:c,panel:e,rng:C,isEdit:n,isImeInput:H,isTrueImeInput:G,templateContext:r,templateCache:j,templateContextProperty:m,cellStamp:g,cellValue:f,cellValueFormatted:w},z=this.shouldInstantiate(F),R=!0;a&&!E&&i!=e.columns.firstVisibleIndex&&y&&(R=!1);if(z){if(n){const e=l.firstElementChild;if(e){H||l.focus();e.style.display="none"}}else this.clearCell(l);this._doDisposeCell(l);if(R){this.renderTemplate(F,!0);F.templateCache=j=l[m]}S=F.cellBindingsData}else{R?this.renderTemplate(F,!1):this._doDisposeCell(l);S=F.cellBindingsData}r.cellOverflow&&(l.style.overflow=r.cellOverflow);v?this.applyImmediately(F):r.autoSizeRows&&!H&&this._markForAutoSize(t,i,e);if(n){R&&queueMicrotask(()=>{this._updateEditRowSize(e,t,i,l)});setTimeout(()=>{H?this._initImeEditInput(F.cell,r):this._initEditInput(F.cell,r,null)},0)}if(n){_._cellEditorVars=S.localVars;var editEndingEH=function(e,t){d.cellEditEnding.removeHandler(editEndingEH);if(!t.stayInEditMode){let e=wjcCore.getActiveElement();e&&e.dispatchEvent(_._evtBlur);wjcCore.contains(l,wjcCore.getActiveElement())&&l.focus()}_._triggerEditorEvents(l);if(!t.cancel&&!t.stayInEditMode){let e=S.localVars,t=Object.getOwnPropertyNames(S.bindings);for(let i of t)S.bindings[i].setValue(e,S.localVars.values[i])}var i=l.querySelectorAll(".wj-dropdown");[].forEach.call(i,(function(e){var t=wjcCore.Control.getControl(e);t&&softInput()&&t instanceof softInput().DropDown&&(t.isDroppedDown=!1)}))};let editEndedEH=function(e,t){d.cellEditEnded.removeHandler(editEndedEH);_._cellEditorVars=null};d.cellEditEnding.addHandler(editEndingEH);d.cellEditEnded.addHandler(editEndedEH)}else this._baseCf.updateCell(e,u,h,l,C,!1);return!0}_updateEditRowSize(e,t,i,l){const r=e.rows[t];let o=this.getHeight(e,t,i,l),s=0;if(this.grid.rowHeaders.columns[0]&&this.grid.rowHeaders.columns[0].isVisible)try{s=this.getHeight(this.grid.rowHeaders,t,0,this.grid.rowHeaders.getCellElement(t,0))}catch(e){}s>o&&(o=s);if(!r.resizedManually&&o>r.renderHeight){const e=r.height;r.height=o;if(this.grid._toInv){clearTimeout(this.grid._toInv);this.grid._listenResizeEvents=!1;this.grid.refreshCells(!0);setTimeout(()=>{this.grid._listenResizeEvents=!0})}const endedHandler=(i,l)=>{r._editHandler=null;i.rowEditEnded.removeHandler(endedHandler);i.rows[t]&&(i.rows[t].height=e||null)};if(!r._editHandler){r._editHandler=endedHandler;this.grid.rowEditEnded.addHandler(endedHandler)}}}_autoSizePanelCells(e,t,i){let l,r=!1,o=0,s=!1,a=e.grid.editableCollectionView&&e.grid.editableCollectionView.currentEditItem;for(let t of e.columns)t.isVisible&&o++;for(let e of t.columns)if(e.isVisible){s=!0;break}const n=e.rows.defaultSize;for(l in i){l=parseInt(l);if(!e.rows[l]||a&&e.rows[l].dataItem===a)continue;if(e.rows[l].resizedManually||null!=e.rows[l].detail)continue;const d=Array.from(i[l].rowHeader),c=Array.from(i[l].cell);let p=-1;for(let e of d){const i=t.getCellElement(l,e);if(i&&(!i.$__cellTemplRowHeaderEdit||i.$__cellTemplRowHeaderEdit&&a)){const r=this.getHeight(t,l,e,i);r>p&&(p=r)}}for(let t of c){const i=e.getCellElement(l,t);if(i){const r=this.getHeight(e,l,t,i);r>p&&(p=r)}}c.length!=o&&n>p&&(p=n);e.grid.headersVisibility&wjcGrid.HeadersVisibility.Row&&s&&0===d.length&&n>p&&(p=n);if(p>-1&&Math.abs(e.rows[l].height-p)>1){e.rows[l].height=p;r=!0}}return r}getHeight(e,t,i,l){let r=l.scrollHeight,o=e.rows,s=e.grid.getMergedRange(e,t,i,!1),a=s&&s.rowSpan||1;if(l.firstElementChild){const e=getComputedStyle(l),t=(parseFloat(e.paddingTop)||0)+(parseFloat(e.paddingBottom)||0),i=(parseFloat(e.borderBottomWidth)||0)+(parseFloat(e.borderTopWidth)||0),o=l.firstElementChild.scrollHeight+t+i;l.firstElementChild.childNodes.length>0&&0!=l.firstElementChild.scrollHeight&&(r=o)}null!=o.maxSize&&(r=Math.min(r,o.maxSize));return r/a}_autoSizeIfRequired(){const e=this.grid.editRange;if(e&&this.grid.columns[e.col]||this.grid._mouseHdl._isDown&&this.grid._mouseHdl._szArgs){this._autoSizeCache={};return}const t=this.grid.viewRange;if(this._autoSizeCache&&this._autoSizeCache.pendingCells)for(let e=t.topRow;e<=t.bottomRow;e++){if(this._autoSizeCache.pendingCells.cells&&this._autoSizeCache.pendingCells.cells[e]){this._autoSizePendingCells();return}if(this._autoSizeCache.pendingCells.headers&&this._autoSizeCache.pendingCells.headers[e]){this._autoSizePendingCells();return}if(this._autoSizeCache.pendingCells.footers&&this._autoSizeCache.pendingCells.footers[e]){this._autoSizePendingCells();return}}}_autoSizePendingCells(){let e=!1,t=!1,i=!1;try{this.grid.beginUpdate();if(!this._autoSizeCache||!this._autoSizeCache.pendingCells)return;this._autoSizeCache.pendingCells.headers&&(e=this._autoSizePanelCells(this.grid.columnHeaders,this.grid.topLeftCells,this._autoSizeCache.pendingCells.headers));this._autoSizeCache.pendingCells.cells&&(t=this._autoSizePanelCells(this.grid.cells,this.grid.rowHeaders,this._autoSizeCache.pendingCells.cells));this._autoSizeCache.pendingCells.footers&&(i=this._autoSizePanelCells(this.grid.columnFooters,this.grid.bottomLeftCells,this._autoSizeCache.pendingCells.footers));this._autoSizeCache={}}finally{this.grid.endUpdate(e||t||i)}}_markForAutoSize(e,t,i){let l,r=!1;this._autoSizeCache.pendingCells||(this._autoSizeCache.pendingCells={});switch(i.cellType){case wjcGrid.CellType.TopLeft:r=!0;case wjcGrid.CellType.ColumnHeader:this._autoSizeCache.pendingCells.headers||(this._autoSizeCache.pendingCells.headers={});l=this._autoSizeCache.pendingCells.headers;break;case wjcGrid.CellType.RowHeader:r=!0;case wjcGrid.CellType.Cell:this._autoSizeCache.pendingCells.cells||(this._autoSizeCache.pendingCells.cells={});l=this._autoSizeCache.pendingCells.cells;break;case wjcGrid.CellType.BottomLeft:r=!0;case wjcGrid.CellType.ColumnFooter:this._autoSizeCache.pendingCells.footers||(this._autoSizeCache.pendingCells.footers={});l=this._autoSizeCache.pendingCells.footers;break;default:return}l[e]||(l[e]={rowHeader:new Set,cell:new Set});r?l[e].rowHeader.add(t):l[e].cell.add(t)}getEditorValue(e){if(this._cellEditorVars){let t=e.editRange;t&&t.isValid&&this._triggerEditorEvents(e.cells.getCellElement(t.row,t.col));return this._cellEditorVars.value}return super.getEditorValue(e)}disposeCell(e){this._doDisposeCell(e)}disposeTemplate(e,t,i){if(t){t.rootElement=null;t.column=null;e[t.templateContextProperty]=null;t.templateContextProperty=null}}setBindingsData(e,t,i,l,r,o){e.row=t;e.col=i;e.item=l;let s={},a=e.cell||{},n={},d={localVars:a,bindings:n};a.row=t;a.col=i;a.item=l;a.value=r;a.valueFormatted=e.cellValueFormatted;a.values=s;if(o){let e=Object.getOwnPropertyNames(o);for(let t of e){let e=new wjcCore.Binding(o[t]);n[t]=e;s[t]=e.getValue(a)}}e.cell!==a&&(e.cell=a);return d}checkHeight(e){this._isCheckingHeight||setTimeout(()=>{let t=e.cell;if(e.cellStamp===t[DirectiveCellFactoryBase._cellStampProp]){var i=t.scrollHeight,l=e.panel.rows,r=e.row.index,o=e.rng,s=o&&o.rowSpan||1,a=e.isEdit;null!=l.maxSize&&(i=Math.min(i,l.maxSize));if(r<l.length&&l[r].renderHeight*s<i-1){const t=i/s;if(a){let i=this._isFullEdit(),l=this.grid;this._backupHeight=e.row.height;e.row.height=t;this._cacheRow=e.row;this._isCheckingHeight=!0;l.refresh();l.startEditing(i);this._isCheckingHeight=!1}}a&&(e.isImeInput?this._initImeEditInput(e.cell,e.templateContext):this._initEditInput(e.cell,e.templateContext,null))}},0)}_restoreRowHeight(){if(!this._isCheckingHeight&&this._cacheRow){this._cacheRow.height=this._backupHeight;this._backupHeight=-1;this._cacheRow=null}}doDisposeCell(e){for(var t=DirectiveCellFactoryBase._templateTypes,i=0;i<t.length;i++){var l=DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType[t[i]]),r=e[l];if(r){let o=(r.column||this.grid)[l];this.disposeTemplate(e,r,o);t[i]==GridCellTemplateType[GridCellTemplateType.CellEdit]&&this._restoreRowHeight()}}}static getTemplContextProp(e){return"$__cellTempl"+GridCellTemplateType[e]}_doDisposeCell(e){this.doDisposeCell(e)}_initEditInput(e,t,i){this.setEditorFocusFlag(!0);let l=!1!==this.getEditorFocusFlag();this.setEditorFocusFlag(null);this._setFullEdit(t);if(l){let t=this._findInitialInput(e);if(t){var inpFocusEh=()=>{t.removeEventListener("focus",inpFocusEh);setTimeout(()=>{let e=null!=i?i:this._editChar;if(e){t.value=e;this._editChar=null;DirectiveCellFactoryBase._setSelectionRange(t,e.length,e.length);t.dispatchEvent(this._evtInput)}},DirectiveCellFactoryBase._FOCUS_INTERVAL)};t.addEventListener("focus",inpFocusEh);t.focus()}}}_initImeEditInput(e,t){let i=wjcCore.getActiveElement();if(i&&(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement)&&wjcCore.hasClass(i,"wj-grid-ime")){let l=this._findInitialInput(e),r=l&&l.style.color,o=this._composing,compEndEh=()=>{i.removeEventListener("compositionend",compEndEh);wjcCore.setCss(i,wjcGrid._ImeHandler._cssHidden);this.setEditorFocusFlag(!0);l&&(l.style.color=r);this._initEditInput(e,t,o?i.value:null)};if(o){i.addEventListener("compositionend",compEndEh);if(l){let e=l.getBoundingClientRect(),t=i.getBoundingClientRect(),r=window.getComputedStyle(i),o=parseFloat(r.left),s=parseFloat(r.top);wjcCore.setCss(i,{left:o+e.left-t.left+"px",top:s+e.top-t.top+"px",width:e.width+"px",height:e.height+"px"});l.style.color="transparent"}}else setTimeout(()=>compEndEh(),DirectiveCellFactoryBase._FOCUS_INTERVAL)}}_findInitialInput(e){let t=e&&e.rootElement&&e.rootElement.querySelectorAll("input,textarea")||e&&e.querySelectorAll("input,textarea");if(t)for(var i=0;i<t.length;i++){var l=t[i],r=window.getComputedStyle(l);if("none"!==r.display&&"visible"===r.visibility)return l}return null}static _setSelectionRange(e,t,i=t){if(wjcCore.contains(document.body,e)&&!e.disabled&&"none"!=e.style.display)try{e.setSelectionRange(wjcCore.asNumber(t),wjcCore.asNumber(i),wjcCore.isIE()?null:"backward");e.focus()}catch(e){}}_triggerEditorEvents(e){if(e){let t=e.querySelectorAll(".wj-control");for(let e=0;e<t.length;e++){let i=t[e],l=wjcCore.Control.getControl(i);l&&this.flushPendingEvents(l)}}}_isFullEdit(){let e=this.grid;return!e.activeEditor||e._edtHdl._fullEdit}_setFullEdit(e){let t=this.grid;e.forceFullEdit&&t.activeEditor&&(t._edtHdl._fullEdit=!0)}}DirectiveCellFactoryBase._cellStampProp="__wjCellStamp";DirectiveCellFactoryBase._FOCUS_INTERVAL=wjcCore.Control._FOCUS_INTERVAL+20;exports.DirectiveCellFactoryBase=DirectiveCellFactoryBase;__gridCFRef||(window.wijmo.grid=null);!function(e){e[e.Cell=0]="Cell";e[e.CellEdit=1]="CellEdit";e[e.ColumnHeader=2]="ColumnHeader";e[e.RowHeader=3]="RowHeader";e[e.RowHeaderEdit=4]="RowHeaderEdit";e[e.TopLeft=5]="TopLeft";e[e.GroupHeader=6]="GroupHeader";e[e.Group=7]="Group";e[e.NewCellTemplate=8]="NewCellTemplate";e[e.ColumnFooter=9]="ColumnFooter";e[e.BottomLeft=10]="BottomLeft"}(GridCellTemplateType=exports.GridCellTemplateType||(exports.GridCellTemplateType={}));wijmo_1._registerModule("wijmo.interop.grid",selfModule);